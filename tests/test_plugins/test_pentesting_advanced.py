"""Tests for advanced pentesting plugin run() methods."""

import time
from unittest.mock import AsyncMock, MagicMock

from basilisk.models.target import Target


class TestCommandInjection:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.command_injection import CommandInjectionPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = CommandInjectionPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_injection_found(self, mock_ctx):
        from basilisk.plugins.pentesting.command_injection import CommandInjectionPlugin

        target = Target.domain("example.com")
        mock_ctx.state["http_scheme"] = {"example.com": "https"}

        mock_resp = MagicMock()
        mock_resp.status = 200
        mock_resp.text = AsyncMock(return_value="<html>Normal page</html>")
        mock_resp.headers = {}
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)
        mock_ctx.http.head = AsyncMock(return_value=mock_resp)

        plugin = CommandInjectionPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestSstiCheck:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.ssti_check import SstiCheckPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = SstiCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_ssti_found(self, mock_ctx):
        from basilisk.plugins.pentesting.ssti_check import SstiCheckPlugin

        target = Target.domain("example.com")
        mock_ctx.state["http_scheme"] = {"example.com": "https"}

        mock_resp = MagicMock()
        mock_resp.status = 200
        mock_resp.text = AsyncMock(return_value="<html>Normal</html>")
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)
        mock_ctx.http.post = AsyncMock(return_value=mock_resp)
        mock_ctx.http.head = AsyncMock(return_value=mock_resp)

        plugin = SstiCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestXxeCheck:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.xxe_check import XxeCheckPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = XxeCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_xxe_found(self, mock_ctx):
        from basilisk.plugins.pentesting.xxe_check import XxeCheckPlugin

        target = Target.domain("example.com")

        mock_head = MagicMock()
        mock_head.status = 200
        mock_ctx.http.head = AsyncMock(return_value=mock_head)

        mock_resp = MagicMock()
        mock_resp.status = 200
        mock_resp.text = AsyncMock(return_value="<response>ok</response>")
        mock_ctx.http.post = AsyncMock(return_value=mock_resp)

        plugin = XxeCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestCorsExploit:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.cors_exploit import CorsExploitPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = CorsExploitPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status in ("error", "skipped")

    async def test_no_cors_scan_upstream(self, mock_ctx):
        from basilisk.plugins.pentesting.cors_exploit import CorsExploitPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}  # No cors_scan results

        plugin = CorsExploitPlugin()
        result = await plugin.run(target, mock_ctx)
        # Should be skipped or success with no exploits
        assert result.ok or result.status == "skipped"


class TestJwtAttack:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.jwt_attack import JwtAttackPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = JwtAttackPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_jwt_found(self, mock_ctx):
        from basilisk.plugins.pentesting.jwt_attack import JwtAttackPlugin

        target = Target.domain("example.com")

        mock_head = MagicMock()
        mock_head.status = 200
        mock_ctx.http.head = AsyncMock(return_value=mock_head)

        mock_resp = MagicMock()
        mock_resp.status = 200
        mock_resp.text = AsyncMock(return_value="<html>No tokens here</html>")
        mock_resp.headers = {"Content-Type": "text/html"}
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)

        plugin = JwtAttackPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestCachePoison:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.cache_poison import CachePoisonPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = CachePoisonPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_cache_found(self, mock_ctx):
        from basilisk.plugins.pentesting.cache_poison import CachePoisonPlugin

        target = Target.domain("example.com")

        mock_head = MagicMock()
        mock_head.status = 200
        mock_ctx.http.head = AsyncMock(return_value=mock_head)

        mock_resp = MagicMock()
        mock_resp.status = 200
        mock_resp.text = AsyncMock(return_value="<html>Normal</html>")
        mock_resp.headers = {"Content-Type": "text/html"}
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)

        plugin = CachePoisonPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestHttpSmuggling:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.http_smuggling import HttpSmugglingPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = HttpSmugglingPlugin()
        result = await plugin.run(target, mock_ctx)
        # Plugin uses raw sockets, not ctx.http; returns success with info
        assert result.ok

    async def test_no_smuggling_found(self, mock_ctx):
        from basilisk.plugins.pentesting.http_smuggling import HttpSmugglingPlugin

        target = Target.domain("example.com")

        mock_head = MagicMock()
        mock_head.status = 200
        mock_ctx.http.head = AsyncMock(return_value=mock_head)

        mock_resp = MagicMock()
        mock_resp.status = 200
        mock_resp.text = AsyncMock(return_value="<html>Normal</html>")
        mock_resp.headers = {"Content-Type": "text/html"}
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)

        plugin = HttpSmugglingPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestSensitiveFiles:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.sensitive_files import SensitiveFilesPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = SensitiveFilesPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_files_found(self, mock_ctx):
        from basilisk.plugins.pentesting.sensitive_files import SensitiveFilesPlugin

        target = Target.domain("example.com")
        mock_ctx._deadline = time.monotonic() + 30

        # HEAD returns 200 for base URL probe, 404 for everything else
        async def fake_head(url, **kwargs):
            resp = MagicMock()
            if url.rstrip("/") in ("https://example.com", "http://example.com"):
                resp.status = 200
                resp.headers = {"content-length": "0"}
            else:
                resp.status = 404
                resp.headers = {"content-length": "0"}
            return resp

        mock_ctx.http.head = fake_head

        mock_resp = MagicMock()
        mock_resp.status = 404
        mock_resp.text = AsyncMock(return_value="Not Found")
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)

        plugin = SensitiveFilesPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok

    async def test_host_unreachable(self, mock_ctx):
        from basilisk.plugins.pentesting.sensitive_files import SensitiveFilesPlugin

        target = Target.domain("example.com")
        mock_ctx._deadline = time.monotonic() + 30
        mock_ctx.http.head = AsyncMock(side_effect=ConnectionError("refused"))

        plugin = SensitiveFilesPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok
