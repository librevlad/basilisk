"""Tests for pentesting plugin run() methods."""

import time
from unittest.mock import AsyncMock, MagicMock

from basilisk.models.target import Target
from basilisk.models.types import PortInfo, PortState


class TestGitExposure:
    async def test_git_found(self, mock_ctx):
        from basilisk.plugins.pentesting.git_exposure import GitExposurePlugin

        target = Target.domain("example.com")
        mock_ctx._deadline = time.monotonic() + 30

        # HEAD mock — resolve_base_urls probes HEAD, batch_head_check uses HEAD
        async def fake_head(url, **kwargs):
            resp = MagicMock()
            if ".git/HEAD" in url or ".env" in url:
                resp.status = 200
                resp.headers = {"content-length": "100"}
            else:
                resp.status = 404
                resp.headers = {"content-length": "0"}
            return resp

        mock_ctx.http.head = fake_head

        # GET mock — plugin validates HEAD hits via GET
        async def fake_get(url, **kwargs):
            resp = MagicMock()
            if ".git/HEAD" in url:
                resp.status = 200
                resp.text = AsyncMock(return_value="ref: refs/heads/main\n")
            elif ".env" in url and "_nonexistent_" not in url:
                resp.status = 200
                resp.text = AsyncMock(return_value="DB_PASSWORD=secret\nAPI_KEY=abc123")
            else:
                resp.status = 200
                resp.text = AsyncMock(return_value="<html>Not Found</html>")
            return resp

        mock_ctx.http.get = fake_get

        plugin = GitExposurePlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok
        exposed = result.data.get("exposed_files", [])
        assert len(exposed) > 0

    async def test_nothing_found(self, mock_ctx):
        from basilisk.plugins.pentesting.git_exposure import GitExposurePlugin

        target = Target.domain("example.com")
        mock_ctx._deadline = time.monotonic() + 30

        # HEAD returns 404 for everything except base URL probe
        head_call_count = 0

        async def fake_head(url, **kwargs):
            nonlocal head_call_count
            resp = MagicMock()
            if url.rstrip("/") in ("https://example.com", "http://example.com"):
                resp.status = 200
                resp.headers = {"content-length": "0"}
            else:
                resp.status = 404
                resp.headers = {"content-length": "0"}
            head_call_count += 1
            return resp

        mock_ctx.http.head = fake_head

        # GET for SPA baseline
        mock_resp = MagicMock()
        mock_resp.status = 404
        mock_resp.text = AsyncMock(return_value="Not Found")
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)

        plugin = GitExposurePlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok

    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.git_exposure import GitExposurePlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = GitExposurePlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"


class TestBackupFinder:
    async def test_backup_found(self, mock_ctx):
        from basilisk.plugins.pentesting.backup_finder import BackupFinderPlugin

        target = Target.domain("example.com")
        mock_ctx.state["http_scheme"] = {"example.com": "https"}
        mock_ctx._deadline = time.monotonic() + 30

        async def fake_head(url, **kwargs):
            resp = MagicMock()
            if "backup.zip" in url:
                resp.status = 200
                resp.headers = {"content-length": "5242880"}
            else:
                resp.status = 404
                resp.headers = {}
            return resp

        mock_ctx.http.head = fake_head

        plugin = BackupFinderPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok

    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.backup_finder import BackupFinderPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = BackupFinderPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"


class TestFtpAnon:
    async def test_port_closed(self, mock_ctx):
        from basilisk.plugins.pentesting.ftp_anon import FtpAnonPlugin

        target = Target.domain("example.com")
        mock_ctx.net.check_port = AsyncMock(
            return_value=PortInfo(port=21, state=PortState.CLOSED)
        )

        plugin = FtpAnonPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok
        assert result.data.get("ftp_open") is False

    async def test_no_net(self, mock_ctx):
        from basilisk.plugins.pentesting.ftp_anon import FtpAnonPlugin

        mock_ctx.net = None
        target = Target.domain("example.com")
        plugin = FtpAnonPlugin()
        result = await plugin.run(target, mock_ctx)
        # When net is None, port_open stays False → returns success with ftp_open=False
        assert result.ok
        assert result.data.get("ftp_open") is False


class TestDirBrute:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.dir_brute import DirBrutePlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = DirBrutePlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_host_not_reachable(self, mock_ctx):
        from basilisk.plugins.pentesting.dir_brute import DirBrutePlugin

        target = Target.domain("example.com")
        mock_ctx.state = {}  # No http_scheme cache
        mock_ctx.http.head = AsyncMock(side_effect=ConnectionError("refused"))

        plugin = DirBrutePlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok
        assert result.data.get("total_checked", 0) == 0


class TestXssBasic:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.xss_basic import XssBasicPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = XssBasicPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_reflected_xss(self, mock_ctx):
        from basilisk.plugins.pentesting.xss_basic import XssBasicPlugin

        target = Target.domain("example.com")
        mock_ctx.state["http_scheme"] = {"example.com": "https"}

        async def fake_get(url, **kwargs):
            resp = MagicMock()
            resp.status = 200
            if "basilisk7x3s" in url.lower() or "basilisk" in str(url):
                resp.text = AsyncMock(
                    return_value="<html><body><basilisk7x3s>reflected</body></html>"
                )
            else:
                resp.text = AsyncMock(return_value="<html><body>Normal</body></html>")
            resp.__aenter__ = AsyncMock(return_value=resp)
            resp.__aexit__ = AsyncMock(return_value=False)
            return resp

        mock_ctx.http.get = fake_get

        plugin = XssBasicPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestSqliBasic:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.sqli_basic import SqliBasicPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = SqliBasicPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_sqli_found(self, mock_ctx):
        from basilisk.plugins.pentesting.sqli_basic import SqliBasicPlugin

        target = Target.domain("example.com")
        mock_ctx.state["http_scheme"] = {"example.com": "https"}

        mock_resp = MagicMock()
        mock_resp.status = 200
        mock_resp.text = AsyncMock(return_value="<html>Normal page</html>")
        mock_resp.__aenter__ = AsyncMock(return_value=mock_resp)
        mock_resp.__aexit__ = AsyncMock(return_value=False)
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)

        plugin = SqliBasicPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


def _make_inline_scheme_ctx(mock_ctx):
    """Setup mock_ctx for plugins using inline https→http scheme detection."""
    mock_head = MagicMock()
    mock_head.status = 200
    mock_ctx.http.head = AsyncMock(return_value=mock_head)
    mock_resp = MagicMock()
    mock_resp.status = 200
    mock_resp.text = AsyncMock(return_value="<html>Normal page</html>")
    mock_resp.headers = {"Content-Type": "text/html"}
    mock_ctx.http.get = AsyncMock(return_value=mock_resp)
    mock_ctx.http.post = AsyncMock(return_value=mock_resp)
    return mock_ctx


class TestAdminFinder:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.admin_finder import AdminFinderPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = AdminFinderPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_admin_found(self, mock_ctx):
        from basilisk.plugins.pentesting.admin_finder import AdminFinderPlugin

        target = Target.domain("example.com")
        mock_ctx._deadline = time.monotonic() + 30

        async def fake_head(url, **kwargs):
            resp = MagicMock()
            if url.rstrip("/") in ("https://example.com", "http://example.com"):
                resp.status = 200
                resp.headers = {"content-length": "0"}
            else:
                resp.status = 404
                resp.headers = {"content-length": "0"}
            return resp

        mock_ctx.http.head = fake_head
        mock_resp = MagicMock()
        mock_resp.status = 404
        mock_resp.text = AsyncMock(return_value="Not Found")
        mock_ctx.http.get = AsyncMock(return_value=mock_resp)

        plugin = AdminFinderPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestLfiCheck:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.lfi_check import LfiCheckPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = LfiCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_lfi_found(self, mock_ctx):
        from basilisk.plugins.pentesting.lfi_check import LfiCheckPlugin

        target = Target.domain("example.com")
        _make_inline_scheme_ctx(mock_ctx)

        plugin = LfiCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestOpenRedirect:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.open_redirect import OpenRedirectPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = OpenRedirectPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_redirect_found(self, mock_ctx):
        from basilisk.plugins.pentesting.open_redirect import OpenRedirectPlugin

        target = Target.domain("example.com")
        _make_inline_scheme_ctx(mock_ctx)

        plugin = OpenRedirectPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestHostHeaderInject:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.host_header_inject import HostHeaderInjectPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = HostHeaderInjectPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_injection_found(self, mock_ctx):
        from basilisk.plugins.pentesting.host_header_inject import HostHeaderInjectPlugin

        target = Target.domain("example.com")
        _make_inline_scheme_ctx(mock_ctx)

        plugin = HostHeaderInjectPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestCsrfCheck:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.csrf_check import CsrfCheckPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = CsrfCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_forms_found(self, mock_ctx):
        from basilisk.plugins.pentesting.csrf_check import CsrfCheckPlugin

        target = Target.domain("example.com")
        _make_inline_scheme_ctx(mock_ctx)

        plugin = CsrfCheckPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestCrlfInjection:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.crlf_injection import CrlfInjectionPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = CrlfInjectionPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_crlf_found(self, mock_ctx):
        from basilisk.plugins.pentesting.crlf_injection import CrlfInjectionPlugin

        target = Target.domain("example.com")
        _make_inline_scheme_ctx(mock_ctx)

        plugin = CrlfInjectionPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestErrorDisclosure:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.error_disclosure import ErrorDisclosurePlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = ErrorDisclosurePlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_errors_disclosed(self, mock_ctx):
        from basilisk.plugins.pentesting.error_disclosure import ErrorDisclosurePlugin

        target = Target.domain("example.com")
        _make_inline_scheme_ctx(mock_ctx)

        plugin = ErrorDisclosurePlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok


class TestDebugEndpoints:
    async def test_no_http(self, mock_ctx):
        from basilisk.plugins.pentesting.debug_endpoints import DebugEndpointsPlugin

        mock_ctx.http = None
        target = Target.domain("example.com")
        plugin = DebugEndpointsPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.status == "error"

    async def test_no_debug_found(self, mock_ctx):
        from basilisk.plugins.pentesting.debug_endpoints import DebugEndpointsPlugin

        target = Target.domain("example.com")
        _make_inline_scheme_ctx(mock_ctx)

        plugin = DebugEndpointsPlugin()
        result = await plugin.run(target, mock_ctx)
        assert result.ok
