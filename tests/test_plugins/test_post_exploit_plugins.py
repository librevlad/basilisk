"""Tests for post-exploitation category plugins â€” meta, discovery, mock run()."""

from __future__ import annotations

import pytest

from basilisk.core.plugin import BasePlugin, PluginCategory
from basilisk.core.registry import PluginRegistry
from basilisk.models.result import PluginResult
from basilisk.models.target import Target

POST_EXPLOIT_PLUGINS = [
    "credential_harvest", "file_system_enum", "linux_enum",
    "network_enum", "process_enum", "user_enum", "windows_enum",
]


class TestPostExploitDiscovery:
    """Verify all post_exploit plugins are discovered and have valid meta."""

    def test_all_post_exploit_discovered(self):
        registry = PluginRegistry()
        registry.discover()
        found = registry.by_category(PluginCategory.POST_EXPLOIT)
        names = {p.meta.name for p in found}
        for expected in POST_EXPLOIT_PLUGINS:
            assert expected in names, f"Missing post_exploit plugin: {expected}"

    def test_post_exploit_count(self):
        registry = PluginRegistry()
        registry.discover()
        found = registry.by_category(PluginCategory.POST_EXPLOIT)
        assert len(found) == 7


class TestPostExploitMeta:
    """Validate metadata for each post_exploit plugin."""

    @pytest.fixture
    def registry(self):
        r = PluginRegistry()
        r.discover()
        return r

    @pytest.mark.parametrize("plugin_name", POST_EXPLOIT_PLUGINS)
    def test_meta_fields(self, registry, plugin_name):
        cls = registry.get(plugin_name)
        assert cls is not None, f"Plugin {plugin_name} not found"
        meta = cls.meta
        assert meta.name == plugin_name
        assert meta.display_name
        assert meta.category == PluginCategory.POST_EXPLOIT
        assert meta.timeout > 0
        assert isinstance(meta.produces, list)

    @pytest.mark.parametrize("plugin_name", POST_EXPLOIT_PLUGINS)
    def test_is_base_plugin(self, registry, plugin_name):
        cls = registry.get(plugin_name)
        assert issubclass(cls, BasePlugin)


class TestCredentialHarvestRun:
    async def test_run_returns_result(self, mock_ctx):
        from basilisk.plugins.post_exploit.credential_harvest import CredentialHarvestPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}
        plugin = CredentialHarvestPlugin()
        result = await plugin.run(target, mock_ctx)
        assert isinstance(result, PluginResult)


class TestFileSystemEnumRun:
    async def test_run_returns_result(self, mock_ctx):
        from basilisk.plugins.post_exploit.file_system_enum import FileSystemEnumPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}
        plugin = FileSystemEnumPlugin()
        result = await plugin.run(target, mock_ctx)
        assert isinstance(result, PluginResult)


class TestLinuxEnumRun:
    async def test_run_returns_result(self, mock_ctx):
        from basilisk.plugins.post_exploit.linux_enum import LinuxEnumPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}
        plugin = LinuxEnumPlugin()
        result = await plugin.run(target, mock_ctx)
        assert isinstance(result, PluginResult)


class TestNetworkEnumRun:
    async def test_run_returns_result(self, mock_ctx):
        from basilisk.plugins.post_exploit.network_enum import NetworkEnumPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}
        plugin = NetworkEnumPlugin()
        result = await plugin.run(target, mock_ctx)
        assert isinstance(result, PluginResult)


class TestProcessEnumRun:
    async def test_run_returns_result(self, mock_ctx):
        from basilisk.plugins.post_exploit.process_enum import ProcessEnumPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}
        plugin = ProcessEnumPlugin()
        result = await plugin.run(target, mock_ctx)
        assert isinstance(result, PluginResult)


class TestUserEnumRun:
    async def test_run_returns_result(self, mock_ctx):
        from basilisk.plugins.post_exploit.user_enum import UserEnumPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}
        plugin = UserEnumPlugin()
        result = await plugin.run(target, mock_ctx)
        assert isinstance(result, PluginResult)


class TestWindowsEnumRun:
    async def test_run_returns_result(self, mock_ctx):
        from basilisk.plugins.post_exploit.windows_enum import WindowsEnumPlugin

        target = Target.domain("example.com")
        mock_ctx.pipeline = {}
        plugin = WindowsEnumPlugin()
        result = await plugin.run(target, mock_ctx)
        assert isinstance(result, PluginResult)
