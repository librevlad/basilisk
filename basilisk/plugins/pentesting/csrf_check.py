"""CSRF token analysis â€” checks forms for anti-CSRF protection."""

from __future__ import annotations

import re
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target


class CsrfCheckPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="csrf_check",
        display_name="CSRF Token Check",
        category=PluginCategory.PENTESTING,
        description="Analyzes forms for anti-CSRF token protection",
        produces=["csrf_findings"],
        timeout=15.0,
    )

    CSRF_TOKEN_NAMES = {
        "csrf", "csrftoken", "csrf_token", "_token", "authenticity_token",
        "__requestverificationtoken", "csrfmiddlewaretoken", "xsrf-token",
        "_csrf", "anti-csrf-token", "nonce",
    }

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        forms_checked = 0
        unprotected = 0

        pages = ["/", "/login", "/contact", "/register", "/account"]

        for scheme in ("https", "http"):
            base = f"{scheme}://{target.host}"
            reachable = False

            for page in pages:
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(f"{base}{page}", timeout=8.0)
                        if resp.status != 200:
                            continue
                        reachable = True
                        body = await resp.text(encoding="utf-8", errors="replace")

                        forms = re.findall(
                            r'<form\b([^>]*)>(.*?)</form>',
                            body, re.IGNORECASE | re.DOTALL,
                        )
                        for attrs, content in forms:
                            method = ""
                            m = re.search(r'method\s*=\s*["\']?(\w+)', attrs, re.IGNORECASE)
                            if m:
                                method = m.group(1).upper()

                            if method != "POST":
                                continue

                            forms_checked += 1
                            has_csrf = any(
                                name in content.lower()
                                for name in self.CSRF_TOKEN_NAMES
                            )
                            if not has_csrf:
                                unprotected += 1
                except Exception:
                    continue

            if reachable:
                break

        if unprotected > 0:
            findings.append(Finding.medium(
                f"CSRF: {unprotected} POST form(s) without anti-CSRF token",
                description="Forms submit POST requests without CSRF protection",
                remediation="Add anti-CSRF tokens to all state-changing forms",
                tags=["pentesting", "csrf"],
            ))
        elif forms_checked > 0:
            findings.append(Finding.info(
                f"All {forms_checked} POST forms have CSRF tokens",
                tags=["pentesting", "csrf"],
            ))
        else:
            findings.append(Finding.info(
                "No POST forms found to check",
                tags=["pentesting", "csrf"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"forms_checked": forms_checked, "unprotected": unprotected},
        )
