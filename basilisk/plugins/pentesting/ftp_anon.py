"""Anonymous FTP check plugin."""

from __future__ import annotations

import asyncio
import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)


class FtpAnonPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="ftp_anon",
        display_name="Anonymous FTP Check",
        category=PluginCategory.PENTESTING,
        description="Tests for anonymous FTP access",
        produces=["ftp_info"],
        timeout=15.0,
        requires_http=False,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []

        port_open = False
        if ctx.net:
            port_info = await ctx.net.check_port(target.host, 21, timeout=5.0)
            port_open = port_info.state == "open"

        if not port_open:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("FTP port 21 not open")],
                data={"ftp_open": False, "anon_access": False},
            )

        anon_access = False
        banner = ""

        import contextlib

        with contextlib.suppress(Exception):
            banner, anon_access = await asyncio.wait_for(
                self._try_anon_ftp(target.host),
                timeout=10.0,
            )

        if anon_access:
            findings.append(Finding.high(
                "Anonymous FTP access allowed",
                description="FTP server allows anonymous login",
                evidence=f"Banner: {banner}",
                remediation=(
                    "Disable anonymous FTP access or restrict "
                    "to specific directories"
                ),
                tags=["pentesting", "ftp", "anonymous-access"],
            ))
        else:
            findings.append(Finding.info(
                "FTP open but anonymous access denied",
                evidence=f"Banner: {banner}",
                tags=["pentesting", "ftp"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={
                "ftp_open": True,
                "anon_access": anon_access,
                "banner": banner,
            },
        )

    async def _try_anon_ftp(self, host: str) -> tuple[str, bool]:
        """Try anonymous FTP login. Returns (banner, success)."""
        reader, writer = await asyncio.open_connection(host, 21)
        try:
            banner_line = await asyncio.wait_for(
                reader.readline(), timeout=5.0,
            )
            banner = banner_line.decode("utf-8", errors="replace").strip()

            writer.write(b"USER anonymous\r\n")
            await writer.drain()
            resp = await asyncio.wait_for(reader.readline(), timeout=5.0)
            resp_text = resp.decode("utf-8", errors="replace").strip()

            if resp_text.startswith("331"):
                writer.write(b"PASS guest@example.com\r\n")
                await writer.drain()
                resp = await asyncio.wait_for(
                    reader.readline(), timeout=5.0,
                )
                resp_text = resp.decode("utf-8", errors="replace").strip()

            writer.write(b"QUIT\r\n")
            await writer.drain()

            return banner, resp_text.startswith("230")
        finally:
            writer.close()
            await writer.wait_closed()
