"""Sensitive file exposure â€” discovers config files, logs, and databases."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

SENSITIVE_FILES = [
    # .env files handled by git_exposure plugin
    ("wp-config.php.bak", "critical", "WordPress config backup"),
    ("config.php.bak", "critical", "PHP config backup"),
    ("database.yml", "high", "Database configuration"),
    ("config/database.yml", "high", "Rails database config"),
    (".htaccess", "medium", "Apache configuration"),
    (".htpasswd", "critical", "Apache password file"),
    ("web.config", "medium", "IIS configuration"),
    ("composer.json", "low", "PHP dependencies"),
    ("package.json", "low", "Node.js dependencies"),
    ("Gemfile", "low", "Ruby dependencies"),
    ("requirements.txt", "low", "Python dependencies"),
    ("docker-compose.yml", "medium", "Docker configuration"),
    ("Dockerfile", "low", "Docker build file"),
    (".dockerenv", "medium", "Docker environment marker"),
    ("debug.log", "medium", "Debug log file"),
    ("error.log", "medium", "Error log file"),
    ("access.log", "low", "Access log file"),
    ("server-status", "medium", "Apache server status"),
    ("server-info", "medium", "Apache server info"),
    (".DS_Store", "low", "macOS directory metadata"),
    ("crossdomain.xml", "low", "Flash cross-domain policy"),
    ("phpinfo.php", "medium", "PHP info page"),
    ("info.php", "medium", "PHP info page"),
    ("test.php", "low", "Test PHP file"),
    ("dump.sql", "critical", "SQL database dump"),
    ("backup.sql", "critical", "SQL backup file"),
    (".ssh/id_rsa", "critical", "SSH private key"),
    ("id_rsa", "critical", "SSH private key"),
    # Cloud credentials
    (".aws/credentials", "critical", "AWS credentials file"),
    (".aws/config", "high", "AWS config file"),
    (".gcloud/credentials.json", "critical", "Google Cloud credentials"),
    (".azure/credentials", "critical", "Azure credentials"),
    ("firebase.json", "medium", "Firebase configuration"),
    # Package configs
    ("yarn.lock", "low", "Yarn lockfile"),
    ("pnpm-lock.yaml", "low", "pnpm lockfile"),
    ("Pipfile", "low", "Python Pipfile"),
    ("Pipfile.lock", "low", "Python Pipfile lock"),
    ("poetry.lock", "low", "Poetry lockfile"),
    ("go.sum", "low", "Go module checksums"),
    ("Cargo.toml", "low", "Rust Cargo manifest"),
    # Docker
    (".dockerignore", "low", "Docker ignore file"),
    ("docker-compose.override.yml", "medium", "Docker Compose override"),
    # Framework configs
    (".babelrc", "low", "Babel config"),
    (".eslintrc", "low", "ESLint config"),
    ("tsconfig.json", "low", "TypeScript config"),
    ("webpack.config.js", "low", "Webpack config (may expose paths)"),
    ("next.config.js", "low", "Next.js config"),
    ("nuxt.config.js", "low", "Nuxt.js config"),
    (".github/workflows/deploy.yml", "medium", "GitHub Actions deploy workflow"),
    (".gitlab-ci.yml", "medium", "GitLab CI config"),
    # History and keys
    (".bash_history", "high", "Bash history (may contain passwords)"),
    (".mysql_history", "high", "MySQL history"),
    (".psql_history", "high", "PostgreSQL history"),
    ("id_ed25519", "critical", "SSH ED25519 private key"),
    ("id_ecdsa", "critical", "SSH ECDSA private key"),
    (".pgpass", "critical", "PostgreSQL password file"),
    (".my.cnf", "high", "MySQL client config (may contain password)"),
]


class SensitiveFilesPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="sensitive_files",
        display_name="Sensitive File Finder",
        category=PluginCategory.PENTESTING,
        description="Discovers exposed sensitive files (configs, logs, keys)",
        produces=["sensitive_files"],
        timeout=30.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        found: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"sensitive_files": []},
            )

        # Fetch SPA baseline to detect catch-all routing
        spa_baseline = ""
        try:
            async with ctx.rate:
                r = await ctx.http.get(
                    f"{base_url}/_nonexistent_8x7z_test/", timeout=5.0,
                )
                if r.status == 200:
                    spa_baseline = await r.text(
                        encoding="utf-8", errors="replace",
                    )
        except Exception:
            pass

        for path, severity, desc in SENSITIVE_FILES:
            url = f"{base_url}/{path}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=5.0)
                    if resp.status == 200:
                        cl = resp.headers.get("content-length", "0")
                        size = int(cl) if cl.isdigit() else 0
                        ct = resp.headers.get("content-type", "")
                        body = await resp.text(
                            encoding="utf-8", errors="replace",
                        )

                        # Skip HTML error pages
                        if "text/html" in ct:
                            bl = body.lower()
                            if "<html" in bl and "404" in bl:
                                continue

                        # Skip SPA catch-all (same body for any path)
                        if (
                            spa_baseline
                            and "text/html" in ct
                            and abs(len(body) - len(spa_baseline)) < 100
                            and body[:200] == spa_baseline[:200]
                        ):
                            continue

                        # Real sensitive files are NOT HTML
                        if "text/html" in ct and body.strip().startswith(
                            ("<!doctype", "<html", "<!DOCTYPE", "<HTML")
                        ):
                            continue

                        if size > 0 or "text/html" not in ct:
                            found.append({"path": path, "size": size})
                            findings.append(getattr(Finding, severity)(
                                f"Sensitive file exposed: {path}",
                                description=desc,
                                evidence=url,
                                remediation="Remove file or restrict access",
                                tags=["pentesting", "sensitive-file"],
                            ))
            except Exception:
                continue

        if not findings:
            findings.append(Finding.info(
                f"No sensitive files found ({len(SENSITIVE_FILES)} checked)",
                tags=["pentesting", "sensitive-file"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"sensitive_files": found, "checked": len(SENSITIVE_FILES)},
        )
