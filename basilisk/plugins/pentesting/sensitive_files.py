"""Sensitive file exposure — discovers config files, logs, keys, credentials.

Extended file list with content validation, technology-specific patterns,
.env parsing for secrets, cloud credential detection.
"""

from __future__ import annotations

import logging
import re
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target
from basilisk.utils.http import resolve_base_urls

logger = logging.getLogger(__name__)

# (path, severity, description, content_validators)
# content_validators: list of (regex_pattern, boost_severity) — if matched, confirms real file
SENSITIVE_FILES: list[tuple[str, str, str, list[tuple[str, bool]]]] = [
    # ── Environment files ──────────────────────────────────────────
    (".env", "critical", "Environment file with secrets", [
        (r"(?:DB_|DATABASE_|MYSQL_|POSTGRES_)(?:PASSWORD|PASS)", True),
        (r"(?:API_KEY|SECRET_KEY|JWT_SECRET|APP_KEY)\s*=", True),
        (r"(?:AWS_ACCESS_KEY|AWS_SECRET)", True),
    ]),
    (".env.local", "critical", "Local environment file", []),
    (".env.production", "critical", "Production environment file", []),
    (".env.staging", "critical", "Staging environment file", []),
    (".env.development", "high", "Development environment file", []),
    (".env.backup", "critical", "Environment backup", []),
    (".env.bak", "critical", "Environment backup", []),
    (".env.old", "critical", "Old environment file", []),
    (".env.example", "low", "Environment example (may contain real values)", []),

    # ── Config files ───────────────────────────────────────────────
    ("wp-config.php", "critical", "WordPress config", [
        (r"DB_PASSWORD", True),
    ]),
    ("wp-config.php.bak", "critical", "WordPress config backup", []),
    ("wp-config.php~", "critical", "WordPress config backup", []),
    ("wp-config.php.save", "critical", "WordPress config autosave", []),
    ("wp-config.php.swp", "critical", "WordPress config vim swap", []),
    ("wp-config.php.orig", "critical", "WordPress config original", []),
    ("config.php", "high", "PHP config file", []),
    ("config.php.bak", "critical", "PHP config backup", []),
    ("configuration.php", "high", "Joomla config", []),
    ("settings.php", "high", "Drupal settings", []),
    ("local.xml", "high", "Magento config", []),
    ("app/config/parameters.yml", "high", "Symfony parameters", []),
    ("config/database.yml", "high", "Rails database config", [
        (r"password:", True),
    ]),
    ("database.yml", "high", "Database config", []),
    ("config/app.php", "high", "Laravel app config", []),
    ("config/secrets.yml", "critical", "Rails secrets", []),
    ("config/master.key", "critical", "Rails master key", []),

    # ── Apache / Nginx ─────────────────────────────────────────────
    (".htaccess", "medium", "Apache configuration", [
        (r"RewriteRule|AuthType|Require", False),
    ]),
    (".htpasswd", "critical", "Apache password file", [
        (r":\$apr1\$|:\{SHA\}|:\$2[aby]?\$", True),
    ]),
    ("web.config", "medium", "IIS configuration", []),
    ("nginx.conf", "high", "Nginx config", []),
    ("httpd.conf", "high", "Apache config", []),

    # ── SSH keys ───────────────────────────────────────────────────
    (".ssh/id_rsa", "critical", "SSH RSA private key", [
        (r"BEGIN (?:RSA |OPENSSH )?PRIVATE KEY", True),
    ]),
    ("id_rsa", "critical", "SSH RSA private key", []),
    ("id_ed25519", "critical", "SSH ED25519 private key", []),
    ("id_ecdsa", "critical", "SSH ECDSA private key", []),
    (".ssh/authorized_keys", "high", "SSH authorized keys", []),
    (".ssh/known_hosts", "medium", "SSH known hosts", []),

    # ── Cloud credentials ──────────────────────────────────────────
    (".aws/credentials", "critical", "AWS credentials", [
        (r"aws_access_key_id|aws_secret_access_key", True),
    ]),
    (".aws/config", "high", "AWS config", []),
    (".gcloud/credentials.json", "critical", "Google Cloud credentials", []),
    (".azure/credentials", "critical", "Azure credentials", []),
    ("firebase.json", "medium", "Firebase config", []),
    ("google-services.json", "high", "Google services config", []),
    ("service-account.json", "critical", "GCP service account", [
        (r"private_key", True),
    ]),
    (".digitalocean/config.yaml", "high", "DigitalOcean config", []),

    # ── Database ───────────────────────────────────────────────────
    ("dump.sql", "critical", "SQL database dump", [
        (r"INSERT INTO|CREATE TABLE", True),
    ]),
    ("backup.sql", "critical", "SQL backup file", []),
    ("database.sql", "critical", "Database dump", []),
    ("db.sqlite3", "critical", "SQLite database", []),
    ("data.db", "high", "Database file", []),
    (".pgpass", "critical", "PostgreSQL password file", []),
    (".my.cnf", "high", "MySQL client config", [
        (r"password\s*=", True),
    ]),

    # ── Package / dependency files ─────────────────────────────────
    ("composer.json", "low", "PHP Composer manifest", []),
    ("composer.lock", "low", "PHP Composer lockfile", []),
    ("package.json", "low", "Node.js manifest", []),
    ("package-lock.json", "low", "npm lockfile", []),
    ("yarn.lock", "low", "Yarn lockfile", []),
    ("Gemfile", "low", "Ruby Gemfile", []),
    ("Gemfile.lock", "low", "Ruby lockfile", []),
    ("requirements.txt", "low", "Python requirements", []),
    ("Pipfile", "low", "Python Pipfile", []),
    ("Pipfile.lock", "low", "Python Pipfile lock", []),
    ("poetry.lock", "low", "Poetry lockfile", []),
    ("go.sum", "low", "Go module checksums", []),
    ("go.mod", "low", "Go module file", []),
    ("Cargo.toml", "low", "Rust manifest", []),
    ("pom.xml", "low", "Maven POM", []),
    ("build.gradle", "low", "Gradle build file", []),

    # ── Docker ─────────────────────────────────────────────────────
    ("Dockerfile", "low", "Docker build file", []),
    ("docker-compose.yml", "medium", "Docker Compose", [
        (r"password:|MYSQL_ROOT_PASSWORD", True),
    ]),
    ("docker-compose.override.yml", "medium", "Docker Compose override", []),
    (".dockerenv", "medium", "Docker environment marker", []),
    (".dockerignore", "low", "Docker ignore file", []),

    # ── CI/CD ──────────────────────────────────────────────────────
    (".github/workflows/deploy.yml", "medium", "GitHub Actions deploy", []),
    (".github/workflows/ci.yml", "low", "GitHub Actions CI", []),
    (".gitlab-ci.yml", "medium", "GitLab CI config", []),
    (".travis.yml", "low", "Travis CI config", []),
    ("Jenkinsfile", "medium", "Jenkins pipeline", []),
    ("Makefile", "low", "Makefile", []),
    (".circleci/config.yml", "low", "CircleCI config", []),
    ("bitbucket-pipelines.yml", "low", "Bitbucket Pipelines", []),

    # ── Logs ───────────────────────────────────────────────────────
    ("debug.log", "medium", "Debug log", []),
    ("error.log", "medium", "Error log", []),
    ("access.log", "low", "Access log", []),
    ("application.log", "medium", "Application log", []),
    ("laravel.log", "medium", "Laravel log", []),
    ("storage/logs/laravel.log", "medium", "Laravel storage log", []),
    ("var/log/system.log", "medium", "Magento system log", []),
    ("npm-debug.log", "low", "npm debug log", []),
    ("wp-content/debug.log", "medium", "WordPress debug log", []),

    # ── Server status / info ───────────────────────────────────────
    ("server-status", "medium", "Apache server status", []),
    ("server-info", "medium", "Apache server info", []),
    ("phpinfo.php", "medium", "PHP info page", [
        (r"phpinfo\(\)|PHP Version", True),
    ]),
    ("info.php", "medium", "PHP info page", []),
    ("test.php", "low", "Test PHP file", []),
    ("pi.php", "medium", "PHP info page", []),

    # ── IDE / editor files ─────────────────────────────────────────
    (".idea/workspace.xml", "low", "JetBrains IDE config", []),
    (".vscode/settings.json", "low", "VS Code settings", []),
    (".vscode/launch.json", "low", "VS Code debug config", []),
    (".DS_Store", "low", "macOS directory metadata", []),
    ("Thumbs.db", "low", "Windows thumbnails", []),

    # ── Misc ───────────────────────────────────────────────────────
    ("crossdomain.xml", "low", "Flash cross-domain policy", []),
    ("clientaccesspolicy.xml", "low", "Silverlight cross-domain", []),
    (".bash_history", "high", "Bash history", []),
    (".zsh_history", "high", "Zsh history", []),
    (".mysql_history", "high", "MySQL history", []),
    (".psql_history", "high", "PostgreSQL history", []),
    (".python_history", "medium", "Python REPL history", []),
    ("._netrc", "critical", "Netrc credentials", []),
    (".netrc", "critical", "Netrc credentials", []),
    (".npmrc", "medium", "npm config (may contain tokens)", [
        (r"_authToken|//registry", True),
    ]),
    (".yarnrc", "low", "Yarn config", []),

    # ── Framework-specific ─────────────────────────────────────────
    (".babelrc", "low", "Babel config", []),
    (".eslintrc", "low", "ESLint config", []),
    (".eslintrc.json", "low", "ESLint config", []),
    ("tsconfig.json", "low", "TypeScript config", []),
    ("webpack.config.js", "low", "Webpack config", []),
    ("next.config.js", "low", "Next.js config", []),
    ("nuxt.config.js", "low", "Nuxt.js config", []),
    ("angular.json", "low", "Angular config", []),
    ("vue.config.js", "low", "Vue.js config", []),
    ("vite.config.js", "low", "Vite config", []),

    # ── Version control ────────────────────────────────────────────
    (".git/config", "high", "Git config (may expose remotes)", [
        (r"\[remote|url\s*=", False),
    ]),
    (".git/HEAD", "medium", "Git HEAD reference", [
        (r"ref: refs/", False),
    ]),
    (".svn/entries", "medium", "SVN entries", []),
    (".hg/hgrc", "medium", "Mercurial config", []),
    (".bzr/README", "low", "Bazaar repository", []),
    ("CVS/Root", "medium", "CVS repository root", []),
    ("CVS/Entries", "medium", "CVS entries file", []),

    # ── Source code archives ────────────────────────────────────────
    ("index.zip", "high", "Source code archive", []),
    ("index.bak", "high", "Source code backup", []),
    ("index.tar.gz", "high", "Source code archive", []),
    ("backup.zip", "high", "Backup archive", []),
    ("site.zip", "high", "Site archive", []),
    ("www.zip", "high", "Web root archive", []),

    # ── Admin panels ─────────────────────────────────────────────────
    ("admin/", "medium", "Admin panel directory", []),

    # ── Server-side scripts ─────────────────────────────────────────
    ("_mmServerScripts/mysql.php", "high", "Dreamweaver MySQL connector", []),
    ("secured/phpinfo.php", "medium", "PHP info in secured directory", [
        (r"phpinfo\(\)|PHP Version", True),
    ]),
]


class SensitiveFilesPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="sensitive_files",
        display_name="Sensitive File Finder",
        category=PluginCategory.PENTESTING,
        description=(
            f"Discovers {len(SENSITIVE_FILES)} sensitive files: configs, logs, "
            "keys, credentials, cloud secrets, with content validation"
        ),
        produces=["sensitive_files"],
        timeout=45.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available",
            )

        findings: list[Finding] = []
        found: list[dict] = []

        base_urls = await resolve_base_urls(target, ctx)
        if not base_urls:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"sensitive_files": []},
            )

        for base_url in base_urls:
            if ctx.should_stop:
                break

            # SPA baseline
            spa_baseline = ""
            try:
                async with ctx.rate:
                    r = await ctx.http.get(
                        f"{base_url}/_nonexistent_8x7z_test/", timeout=5.0,
                    )
                    if r.status == 200:
                        spa_baseline = await r.text(
                            encoding="utf-8", errors="replace",
                        )
            except Exception as e:
                logger.debug("sensitive_files: %s", e)

            for path, severity, desc, validators in SENSITIVE_FILES:
                if ctx.should_stop:
                    break

                url = f"{base_url}/{path}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(url, timeout=5.0)
                        if resp.status != 200:
                            continue

                        ct = resp.headers.get("content-type", "")
                        body = await resp.text(
                            encoding="utf-8", errors="replace",
                        )

                        # HTML error page filter
                        bl = body.lower().strip()
                        if (
                            "text/html" in ct
                            and "<html" in bl[:500]
                            and ("404" in bl or "not found" in bl)
                        ):
                            continue

                        # SPA catch-all filter
                        if (
                            spa_baseline
                            and abs(len(body) - len(spa_baseline)) < 200
                            and body[:500] == spa_baseline[:500]
                        ):
                            continue

                        # Skip if it looks like an HTML error page
                        if bl.startswith(("<!doctype", "<html")) and "404" in bl:
                            continue

                        # Empty file filter
                        if len(body.strip()) < 5:
                            continue

                        # Content validation (boost severity if confirmed)
                        confirmed = False
                        if validators:
                            for pattern, is_critical in validators:
                                if re.search(pattern, body, re.IGNORECASE):
                                    confirmed = True
                                    if is_critical and severity != "critical":
                                        severity = "critical"
                                    break

                        # Extract secrets from .env files
                        secrets_found: list[str] = []
                        if ".env" in path and body:
                            secrets_found = self._extract_env_secrets(body)

                        evidence_parts = [url]
                        if secrets_found:
                            evidence_parts.append(
                                f"Secrets found: {', '.join(secrets_found[:5])}"
                            )

                        cl = resp.headers.get("content-length", "0")
                        size = int(cl) if cl.isdigit() else len(body)

                        found.append({
                            "path": path, "size": size,
                            "confirmed": confirmed,
                            "secrets": secrets_found[:5],
                        })
                        findings.append(getattr(Finding, severity)(
                            f"Sensitive file exposed: {path}"
                            + (" (confirmed)" if confirmed else ""),
                            description=desc,
                            evidence="\n".join(evidence_parts),
                            remediation="Remove file from web root or restrict access",
                            tags=["pentesting", "sensitive-file"],
                        ))

                except Exception as e:
                    logger.debug("sensitive_files: %s", e)
                    continue

        if not findings:
            findings.append(Finding.info(
                f"No sensitive files found ({len(SENSITIVE_FILES)} checked)",
                tags=["pentesting", "sensitive-file"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"sensitive_files": found, "checked": len(SENSITIVE_FILES)},
        )

    @staticmethod
    def _extract_env_secrets(body: str) -> list[str]:
        """Extract secret key names from .env file content."""
        secret_patterns = [
            r"(DB_PASSWORD|DATABASE_PASSWORD|MYSQL_PASSWORD|POSTGRES_PASSWORD)",
            r"(API_KEY|SECRET_KEY|APP_KEY|JWT_SECRET|AUTH_SECRET)",
            r"(AWS_ACCESS_KEY_ID|AWS_SECRET_ACCESS_KEY)",
            r"(STRIPE_SECRET|STRIPE_KEY|PAYPAL_SECRET)",
            r"(SENDGRID_API_KEY|MAILGUN_SECRET)",
            r"(GITHUB_TOKEN|GITLAB_TOKEN|BITBUCKET_TOKEN)",
            r"(REDIS_PASSWORD|MONGO_PASSWORD|ELASTICSEARCH_PASSWORD)",
            r"(SMTP_PASSWORD|MAIL_PASSWORD|EMAIL_PASSWORD)",
            r"(PRIVATE_KEY|ENCRYPTION_KEY|SIGNING_KEY)",
            r"(OAUTH_CLIENT_SECRET|OAUTH_SECRET)",
        ]
        found: list[str] = []
        for pattern in secret_patterns:
            matches = re.findall(pattern, body, re.IGNORECASE)
            found.extend(matches)
        return list(dict.fromkeys(found))  # Dedupe
