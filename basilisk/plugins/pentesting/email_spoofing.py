"""Email spoofing check — SPF, DKIM, DMARC analysis."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target
from basilisk.utils.dns import is_root_domain


class EmailSpoofingPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="email_spoofing",
        display_name="Email Spoofing Check",
        category=PluginCategory.PENTESTING,
        description="Checks SPF, DKIM, and DMARC for email spoofing protection",
        depends_on=["dns_enum"],
        produces=["email_security"],
        timeout=15.0,
        requires_http=False,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.dns is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="DNS client not available"
            )

        # SPF/DMARC/DKIM are root-domain-only records — skip subdomains
        if not is_root_domain(target.host):
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info(
                    "Email spoofing check skipped (subdomain)",
                    description=(
                        f"{target.host} is a subdomain; SPF/DMARC/DKIM "
                        "are configured on the root domain"
                    ),
                    tags=["pentesting", "email"],
                )],
            )

        findings: list[Finding] = []
        email_sec: dict = {"spf": None, "dmarc": None, "dkim": False}

        # Check SPF
        try:
            txt_records = await ctx.dns.resolve(target.host, "TXT")
            spf_records = [
                r.value for r in (txt_records or [])
                if "v=spf1" in r.value.lower()
            ]
            if spf_records:
                spf = spf_records[0]
                email_sec["spf"] = spf
                if "-all" in spf:
                    findings.append(Finding.info(
                        "SPF: strict (-all)",
                        evidence=spf,
                        tags=["pentesting", "email", "spf"],
                    ))
                elif "~all" in spf:
                    findings.append(Finding.low(
                        "SPF: softfail (~all) — spoofing partially possible",
                        evidence=spf,
                        remediation="Change ~all to -all for strict SPF",
                        tags=["pentesting", "email", "spf"],
                    ))
                elif "?all" in spf or "+all" in spf:
                    findings.append(Finding.medium(
                        "SPF: permissive policy allows spoofing",
                        evidence=spf,
                        remediation="Configure strict SPF with -all",
                        tags=["pentesting", "email", "spf"],
                    ))
            else:
                findings.append(Finding.medium(
                    "No SPF record — email spoofing possible",
                    remediation="Add SPF TXT record",
                    tags=["pentesting", "email", "spf"],
                ))
        except Exception:
            pass

        # Check DMARC
        try:
            dmarc_records = await ctx.dns.resolve(f"_dmarc.{target.host}", "TXT")
            if dmarc_records:
                dmarc = dmarc_records[0].value
                email_sec["dmarc"] = dmarc
                if "p=reject" in dmarc:
                    findings.append(Finding.info(
                        "DMARC: reject policy",
                        evidence=dmarc,
                        tags=["pentesting", "email", "dmarc"],
                    ))
                elif "p=quarantine" in dmarc:
                    findings.append(Finding.info(
                        "DMARC: quarantine policy",
                        evidence=dmarc,
                        tags=["pentesting", "email", "dmarc"],
                    ))
                elif "p=none" in dmarc:
                    findings.append(Finding.low(
                        "DMARC: monitoring only (p=none)",
                        evidence=dmarc,
                        remediation="Upgrade DMARC policy to quarantine or reject",
                        tags=["pentesting", "email", "dmarc"],
                    ))
            else:
                findings.append(Finding.medium(
                    "No DMARC record",
                    remediation="Add DMARC record: _dmarc.domain TXT v=DMARC1; p=reject",
                    tags=["pentesting", "email", "dmarc"],
                ))
        except Exception:
            pass

        # Check for DKIM selector
        common_selectors = ["default", "google", "selector1", "selector2", "k1"]
        for sel in common_selectors:
            try:
                dkim = await ctx.dns.resolve(
                    f"{sel}._domainkey.{target.host}", "TXT",
                )
                if dkim:
                    email_sec["dkim"] = True
                    findings.append(Finding.info(
                        f"DKIM found (selector: {sel})",
                        evidence=dkim[0].value[:100],
                        tags=["pentesting", "email", "dkim"],
                    ))
                    break
            except Exception:
                continue

        if not email_sec["dkim"]:
            findings.append(Finding.low(
                "No DKIM record found (common selectors checked)",
                remediation="Configure DKIM signing",
                tags=["pentesting", "email", "dkim"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data=email_sec,
        )
