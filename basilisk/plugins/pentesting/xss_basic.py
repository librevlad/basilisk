"""Basic reflected XSS detection."""

from __future__ import annotations

from typing import ClassVar
from urllib.parse import quote

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

XSS_CANARY = "basilisk7x3s"
XSS_PAYLOADS = [
    f"<{XSS_CANARY}>",
    f"\"{XSS_CANARY}",
    f"'{XSS_CANARY}",
    f"javascript:{XSS_CANARY}",
    f"<img src=x onerror={XSS_CANARY}>",
    f"<svg onload={XSS_CANARY}>",
    f"<details open ontoggle={XSS_CANARY}>",
    f"<body onload={XSS_CANARY}>",
    f"'-alert({XSS_CANARY})-'",
    f"\"-alert({XSS_CANARY})-\"",
    f"<script>{XSS_CANARY}</script>",
    f"<iframe src=javascript:{XSS_CANARY}>",
    f"<input onfocus={XSS_CANARY} autofocus>",
    f"<marquee onstart={XSS_CANARY}>",
    f"<video><source onerror={XSS_CANARY}>",
]


class XssBasicPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="xss_basic",
        display_name="XSS Scanner",
        category=PluginCategory.PENTESTING,
        description="Detects basic reflected XSS vulnerabilities",
        produces=["xss_findings"],
        timeout=30.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        tested: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"xss_tests": []},
            )

        params = ["q", "search", "query", "s", "keyword", "name", "redirect", "url"]

        for param in params:
            for payload in XSS_PAYLOADS:
                url = f"{base_url}/?{param}={quote(payload)}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(url, timeout=8.0)
                        body = await resp.text(encoding="utf-8", errors="replace")

                        # Check if payload is reflected without encoding
                        if payload in body:
                            tested.append({
                                "param": param, "payload": payload, "reflected": True,
                            })

                            # Check if it's in an HTML context (not just attribute)
                            if f"<{XSS_CANARY}>" in body:
                                findings.append(Finding.high(
                                    f"Reflected XSS: HTML tag injection via ?{param}=",
                                    description="User input reflected as HTML without encoding",
                                    evidence=f"Payload: {payload}",
                                    remediation="Encode all user input in HTML output",
                                    tags=["pentesting", "xss"],
                                ))
                            else:
                                findings.append(Finding.medium(
                                    f"Input reflected in response: ?{param}=",
                                    description="User input reflected in page (potential XSS)",
                                    evidence=f"Payload: {payload}",
                                    remediation="Apply context-aware output encoding",
                                    tags=["pentesting", "xss"],
                                ))
                            break
                except Exception:
                    continue

            if findings:
                break

        if not findings:
            findings.append(Finding.info(
                "No reflected XSS detected",
                tags=["pentesting", "xss"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"xss_tests": tested},
        )
