"""WordPress-specific vulnerability scanner."""

from __future__ import annotations

import re
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target


class WordPressScanPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="wordpress_scan",
        display_name="WordPress Scanner",
        category=PluginCategory.PENTESTING,
        description="Detects WordPress-specific vulnerabilities and misconfigurations",
        produces=["wordpress_findings"],
        timeout=30.0,
    )

    WP_PATHS = [
        ("/wp-login.php", "Login page"),
        ("/wp-admin/", "Admin dashboard"),
        ("/wp-json/wp/v2/users", "User enumeration API"),
        ("/wp-json/", "REST API root"),
        ("/xmlrpc.php", "XML-RPC interface"),
        ("/wp-content/debug.log", "Debug log"),
        ("/wp-config.php.bak", "Config backup"),
        ("/wp-config.php~", "Config editor backup"),
        ("/wp-content/uploads/", "Upload directory listing"),
        ("/readme.html", "WordPress readme (version)"),
        ("/license.txt", "WordPress license (version)"),
        ("/?author=1", "User enumeration via author"),
    ]

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        wp_data: dict = {"is_wordpress": False, "version": "", "issues": []}
        base_url = ""

        # Detect WordPress
        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(
                        f"{scheme}://{target.host}/", timeout=8.0,
                    )
                    body = await resp.text(encoding="utf-8", errors="replace")
                    if "wp-content" in body or "wp-includes" in body:
                        wp_data["is_wordpress"] = True
                        base_url = f"{scheme}://{target.host}"

                        # Extract version
                        ver = re.search(
                            r'content="WordPress\s+([\d.]+)"', body,
                        )
                        if ver:
                            wp_data["version"] = ver.group(1)
                        break
            except Exception:
                continue

        if not wp_data["is_wordpress"]:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Not a WordPress site")],
                data=wp_data,
            )

        if wp_data["version"]:
            findings.append(Finding.low(
                f"WordPress version disclosed: {wp_data['version']}",
                remediation="Remove version from meta generator tag",
                tags=["pentesting", "wordpress", "version"],
            ))

        for path, _desc in self.WP_PATHS:
            url = f"{base_url}{path}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=8.0)

                    if path == "/wp-json/wp/v2/users" and resp.status == 200:
                        body = await resp.text(encoding="utf-8", errors="replace")
                        if '"slug"' in body:
                            findings.append(Finding.medium(
                                "WordPress user enumeration via REST API",
                                evidence=url,
                                remediation="Disable /wp-json/wp/v2/users endpoint",
                                tags=["pentesting", "wordpress", "enum"],
                            ))

                    elif path == "/xmlrpc.php" and resp.status == 200:
                        findings.append(Finding.medium(
                            "XML-RPC enabled",
                            description="XML-RPC can be used for brute force and DDoS",
                            evidence=url,
                            remediation="Disable XML-RPC via plugin or .htaccess",
                            tags=["pentesting", "wordpress", "xmlrpc"],
                        ))

                    elif path == "/wp-content/debug.log" and resp.status == 200:
                        findings.append(Finding.high(
                            "WordPress debug.log exposed",
                            description="Debug log may contain sensitive information",
                            evidence=url,
                            remediation="Remove debug.log and disable WP_DEBUG_LOG",
                            tags=["pentesting", "wordpress"],
                        ))

                    elif "config" in path and resp.status == 200:
                        findings.append(Finding.critical(
                            f"WordPress config backup: {path}",
                            evidence=url,
                            remediation="Remove config backups from web root",
                            tags=["pentesting", "wordpress"],
                        ))

                    elif path == "/wp-content/uploads/" and resp.status == 200:
                        body = await resp.text(encoding="utf-8", errors="replace")
                        if "index of" in body.lower() or "<li>" in body:
                            findings.append(Finding.medium(
                                "Upload directory listing enabled",
                                evidence=url,
                                remediation="Disable directory listing",
                                tags=["pentesting", "wordpress"],
                            ))
            except Exception:
                continue

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data=wp_data,
        )
