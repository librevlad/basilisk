"""Debug endpoint detection — discovers exposed debug and monitoring interfaces.

Discovers:
1. Spring Boot Actuator (env, heapdump, configprops, mappings, beans)
2. Django debug toolbar, admin docs
3. ASP.NET error logs (ELMAH, Trace, Glimpse)
4. Symfony profiler, Laravel Telescope/Horizon
5. Prometheus metrics, health checks
6. API documentation (Swagger, GraphiQL, ReDoc)
7. Go pprof, Flask/Werkzeug console
8. Docker registry, container dashboards
"""

from __future__ import annotations

import json
import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

# (path, description, severity, content_validator_keywords)
DEBUG_PATHS: list[tuple[str, str, str, list[str]]] = [
    # ── Spring Boot Actuator ──────────────────────────────────────────
    ("/actuator", "Spring Boot actuator index", "high", ["_links", "actuator"]),
    ("/actuator/env", "Spring Boot environment", "critical", ["propertySources", "property"]),
    ("/actuator/heapdump", "Spring Boot heap dump", "critical", []),
    ("/actuator/configprops", "Spring Boot config properties", "critical",
     ["contexts", "beans"]),
    ("/actuator/mappings", "Spring Boot URL mappings", "high",
     ["contexts", "dispatcherServlets"]),
    ("/actuator/beans", "Spring Boot beans", "high", ["contexts", "beans"]),
    ("/actuator/health", "Spring Boot health", "low", ["status"]),
    ("/actuator/info", "Spring Boot info", "low", []),
    ("/actuator/loggers", "Spring Boot loggers", "medium", ["loggers", "levels"]),
    ("/actuator/threaddump", "Spring Boot thread dump", "high", ["threads"]),
    ("/actuator/httptrace", "Spring Boot HTTP trace", "high", ["traces"]),
    ("/actuator/trace", "Spring Boot trace (legacy)", "high", ["traces"]),
    ("/actuator/metrics", "Spring Boot metrics", "medium", ["names"]),
    ("/actuator/scheduledtasks", "Spring Boot tasks", "medium", ["cron", "fixedRate"]),
    ("/actuator/sessions", "Spring Boot sessions", "high", ["sessions"]),
    ("/actuator/conditions", "Spring Boot conditions", "medium", ["contexts"]),
    ("/actuator/caches", "Spring Boot caches", "medium", ["cacheManagers"]),
    ("/actuator/flyway", "Spring Boot Flyway", "medium", ["contexts"]),
    ("/actuator/liquibase", "Spring Boot Liquibase", "medium", ["contexts"]),
    ("/actuator/jolokia", "Spring Boot Jolokia (JMX)", "critical",
     ["request", "value", "jolokia"]),
    # ── Go debug ──────────────────────────────────────────────────────
    ("/debug/vars", "Go debug vars", "high", ["memstats", "cmdline"]),
    ("/debug/pprof/", "Go pprof profiler", "high", ["profile", "heap", "goroutine"]),
    # ── Django ────────────────────────────────────────────────────────
    ("/__debug__/", "Django debug toolbar", "high", ["djdt", "debug"]),
    ("/admin/doc/", "Django admin docs", "medium", ["documentation", "models"]),
    ("/debug/toolbar/", "Django Debug Toolbar", "high", ["djdt"]),
    ("/debug/sql/", "Django SQL debug", "high", ["sql", "queries"]),
    # ── ASP.NET ───────────────────────────────────────────────────────
    ("/elmah.axd", "ASP.NET ELMAH error log", "high", ["error", "log"]),
    ("/trace.axd", "ASP.NET trace", "high", ["trace", "request"]),
    ("/glimpse.axd", "ASP.NET Glimpse", "medium", ["glimpse"]),
    # ── Symfony ───────────────────────────────────────────────────────
    ("/_profiler", "Symfony profiler", "high", ["profiler", "toolbar"]),
    ("/_wdt", "Symfony web debug toolbar", "high", ["sf-toolbar"]),
    ("/_profiler/phpinfo", "Symfony phpinfo", "critical", ["phpinfo", "PHP Version"]),
    # ── Laravel ───────────────────────────────────────────────────────
    ("/telescope", "Laravel Telescope", "high", ["telescope", "monitoring"]),
    ("/horizon", "Laravel Horizon", "high", ["horizon", "queue"]),
    ("/clockwork", "Clockwork debugger", "high", ["clockwork"]),
    ("/_debugbar/open", "Laravel Debugbar", "high", ["debugbar"]),
    ("/log-viewer", "Laravel Log Viewer", "high", ["log", "viewer"]),
    # ── Rails ─────────────────────────────────────────────────────────
    ("/rails/info/routes", "Rails routes", "medium", ["routes", "Path"]),
    ("/rails/info/properties", "Rails properties", "medium", ["ruby", "rails"]),
    ("/sidekiq", "Sidekiq dashboard", "high", ["sidekiq", "queue"]),
    # ── Flask / Python ────────────────────────────────────────────────
    ("/console", "Werkzeug console", "critical", ["console", "interactive"]),
    # ── PHP ───────────────────────────────────────────────────────────
    ("/phpinfo.php", "PHP info page", "high", ["phpinfo", "PHP Version"]),
    ("/info.php", "PHP info page", "high", ["phpinfo", "PHP Version"]),
    ("/test.php", "PHP test page", "medium", ["php"]),
    ("/debug.php", "PHP debug page", "high", ["php"]),
    ("/adminer.php", "Adminer DB manager", "critical", ["adminer"]),
    ("/pma/", "phpMyAdmin", "critical", ["phpmyadmin"]),
    ("/phpmyadmin/", "phpMyAdmin", "critical", ["phpmyadmin"]),
    # ── Node.js ───────────────────────────────────────────────────────
    ("/debug", "Debug page", "medium", []),
    ("/__inspect", "Node.js inspect", "high", ["inspect"]),
    ("/node_modules/", "Node modules directory", "high", ["node_modules"]),
    # ── Monitoring & health checks ────────────────────────────────────
    ("/metrics", "Prometheus metrics", "medium", ["# HELP", "# TYPE"]),
    ("/healthcheck", "Health check", "low", []),
    ("/health", "Health check", "low", []),
    ("/ready", "Readiness probe", "low", []),
    ("/healthz", "Kubernetes health check", "low", ["ok"]),
    ("/readyz", "Kubernetes readiness check", "low", ["ok"]),
    ("/livez", "Kubernetes liveness check", "low", ["ok"]),
    # ── Web servers ───────────────────────────────────────────────────
    ("/server-status", "Apache server status", "high", ["Apache", "Server", "Uptime"]),
    ("/server-info", "Apache server info", "high", ["Apache", "Module"]),
    ("/balancer-manager", "Apache balancer manager", "high", ["balancer", "manager"]),
    ("/nginx_status", "Nginx status", "medium", ["Active connections"]),
    ("/nginx/status", "Nginx status (alt)", "medium", ["Active connections"]),
    ("/stub_status", "Nginx stub status", "medium", ["Active connections"]),
    # ── GraphQL ───────────────────────────────────────────────────────
    ("/graphiql", "GraphiQL IDE", "medium", ["graphiql", "GraphQL"]),
    ("/playground", "GraphQL playground", "medium", ["playground", "GraphQL"]),
    ("/graphql/console", "GraphQL console", "medium", ["graphql"]),
    ("/altair", "Altair GraphQL Client", "medium", ["altair", "graphql"]),
    # ── API docs ──────────────────────────────────────────────────────
    ("/swagger", "Swagger API docs", "medium", ["swagger"]),
    ("/swagger-ui.html", "Swagger UI", "medium", ["swagger"]),
    ("/swagger/v1/swagger.json", "Swagger JSON", "medium", ["swagger", "paths"]),
    ("/api-docs", "API documentation", "medium", ["api"]),
    ("/openapi.json", "OpenAPI spec", "medium", ["openapi", "paths"]),
    ("/redoc", "ReDoc API docs", "medium", ["redoc", "api"]),
    # ── Containers / Infra ────────────────────────────────────────────
    ("/haproxy?stats", "HAProxy stats", "high", ["HAProxy", "Statistics"]),
    ("/v2/_catalog", "Docker Registry catalog", "critical", ["repositories"]),
    ("/traefik", "Traefik dashboard", "high", ["traefik"]),
    ("/debug/pprof/", "Container debug pprof", "high", ["profile", "heap"]),
    # ── Environment / config ──────────────────────────────────────────
    ("/.env", "Environment file", "critical", ["DB_", "APP_", "SECRET"]),
    ("/config", "Configuration", "medium", []),
    ("/debug/", "Debug page", "medium", []),
    ("/_debug", "Debug page", "medium", []),
    # ── Diagnostic / system ───────────────────────────────────────────
    ("/api/debug", "API debug endpoint", "high", ["debug"]),
    ("/api/v1/debug", "API v1 debug endpoint", "high", ["debug"]),
    ("/system/console", "System console", "critical", ["console"]),
    ("/diag", "Diagnostics page", "medium", ["diag"]),
    ("/diagnostics", "Diagnostics page", "medium", ["diagnostic"]),
    # ── WP-specific ───────────────────────────────────────────────────
    ("/wp-json/wp/v2/users", "WP user enumeration", "medium", ["slug", "name"]),
]


class DebugEndpointsPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="debug_endpoints",
        display_name="Debug Endpoint Finder",
        category=PluginCategory.PENTESTING,
        description=(
            "Discovers exposed debug, profiler, monitoring, "
            "and API documentation endpoints"
        ),
        produces=["debug_endpoints"],
        timeout=35.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available",
            )

        from basilisk.utils.http_check import resolve_base_url

        findings: list[Finding] = []
        found: list[dict] = []

        base_url = await resolve_base_url(target.host, ctx)
        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"debug_endpoints": []},
            )

        # SPA baseline detection
        spa_baseline = ""
        try:
            async with ctx.rate:
                r = await ctx.http.get(
                    f"{base_url}/_nonexistent_path_8x7z/", timeout=5.0,
                )
                if r.status == 200:
                    spa_baseline = await r.text(encoding="utf-8", errors="replace")
        except Exception as e:
            logger.debug("debug_endpoints: %s", e)

        for path, desc, sev, validators in DEBUG_PATHS:
            if ctx.should_stop:
                break

            url = f"{base_url}{path}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=5.0)
                    if resp.status != 200:
                        continue

                    body = await resp.text(encoding="utf-8", errors="replace")

                    # Skip tiny responses
                    if len(body) < 50:
                        continue

                    # Skip 404-as-200
                    if "404" in body[:500] and "not found" in body[:500].lower():
                        continue

                    # Skip SPA catch-all
                    if (
                        spa_baseline
                        and abs(len(body) - len(spa_baseline)) < 100
                        and body[:200] == spa_baseline[:200]
                    ):
                        continue

                    # Content validation — check if keywords are present
                    if validators:
                        body_lower = body.lower()
                        matched = sum(
                            1 for v in validators if v.lower() in body_lower
                        )
                        if matched == 0:
                            continue

                    # Check if response looks like JSON (actuator endpoints)
                    is_json = False
                    if validators:
                        try:
                            json.loads(body)
                            is_json = True
                        except (json.JSONDecodeError, ValueError):
                            pass

                    found.append({
                        "path": path,
                        "description": desc,
                        "severity": sev,
                        "json": is_json,
                        "size": len(body),
                    })

                    severity_fn = getattr(Finding, sev)
                    findings.append(severity_fn(
                        f"Debug endpoint: {path}",
                        description=f"{desc} ({len(body)} bytes)",
                        evidence=url,
                        remediation=(
                            "Disable debug/monitoring endpoints in production. "
                            "Restrict access via firewall or authentication."
                        ),
                        tags=["pentesting", "debug", sev],
                    ))
            except Exception as e:
                logger.debug("debug_endpoints: %s", e)
                continue

        if not findings:
            findings.append(Finding.info(
                f"No debug endpoints found ({len(DEBUG_PATHS)} checked)",
                tags=["pentesting", "debug"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"debug_endpoints": found},
        )
