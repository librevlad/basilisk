"""Debug endpoint detection â€” discovers exposed debug and monitoring interfaces."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

DEBUG_PATHS = [
    # General debug
    ("/debug", "Debug page"),
    ("/debug/", "Debug page"),
    ("/_debug", "Debug page"),
    ("/debug/vars", "Go debug vars"),
    ("/debug/pprof/", "Go pprof profiler"),
    # Django
    ("/__debug__/", "Django debug toolbar"),
    ("/admin/doc/", "Django admin docs"),
    # ASP.NET
    ("/elmah.axd", "ASP.NET error log"),
    ("/trace.axd", "ASP.NET trace"),
    ("/glimpse.axd", "ASP.NET Glimpse"),
    # Spring Boot Actuator (full)
    ("/actuator", "Spring Boot actuator"),
    ("/actuator/env", "Spring Boot environment"),
    ("/actuator/heapdump", "Spring Boot heap dump"),
    ("/actuator/configprops", "Spring Boot config"),
    ("/actuator/mappings", "Spring Boot URL mappings"),
    ("/actuator/beans", "Spring Boot beans"),
    ("/actuator/health", "Spring Boot health"),
    ("/actuator/info", "Spring Boot info"),
    ("/actuator/loggers", "Spring Boot loggers"),
    ("/actuator/threaddump", "Spring Boot thread dump"),
    ("/actuator/httptrace", "Spring Boot HTTP trace"),
    ("/actuator/metrics", "Spring Boot metrics"),
    ("/actuator/scheduledtasks", "Spring Boot scheduled tasks"),
    ("/actuator/conditions", "Spring Boot conditions"),
    ("/actuator/caches", "Spring Boot caches"),
    ("/actuator/flyway", "Spring Boot Flyway migrations"),
    # Symfony
    ("/_profiler", "Symfony profiler"),
    ("/_wdt", "Symfony web debug toolbar"),
    ("/_profiler/phpinfo", "Symfony phpinfo"),
    ("/_profiler/open", "Symfony profiler open"),
    ("/_profiler/search", "Symfony profiler search"),
    # Laravel
    ("/telescope", "Laravel Telescope"),
    ("/horizon", "Laravel Horizon"),
    ("/nova", "Laravel Nova"),
    ("/clockwork", "Clockwork debug"),
    ("/ray", "Spatie Ray debug"),
    ("/log-viewer", "Laravel Log Viewer"),
    ("/_debugbar/open", "Laravel Debugbar"),
    # Rails / Ruby
    ("/console", "H2/Rails console"),
    ("/rails/info/routes", "Rails routes info"),
    ("/rails/info/properties", "Rails properties"),
    ("/sidekiq", "Sidekiq dashboard"),
    # Flask / Python
    ("/console", "Flask/Werkzeug console"),
    # Monitoring
    ("/metrics", "Prometheus metrics"),
    ("/healthcheck", "Health check endpoint"),
    ("/health", "Health check"),
    ("/ready", "Readiness probe"),
    ("/alive", "Liveness probe"),
    # Web servers
    ("/server-status", "Apache server status"),
    ("/server-info", "Apache server info"),
    ("/nginx_status", "Nginx status"),
    ("/stub_status", "Nginx stub status"),
    # General
    ("/status", "Status page"),
    ("/.env", "Environment file"),
    ("/config", "Configuration endpoint"),
    ("/info", "Info endpoint"),
    ("/stats", "Stats endpoint"),
    ("/monitoring", "Monitoring dashboard"),
    # DevOps
    ("/graphql", "GraphQL endpoint"),
    ("/graphiql", "GraphiQL IDE"),
    ("/playground", "GraphQL playground"),
    ("/swagger", "Swagger API docs"),
    ("/swagger-ui.html", "Swagger UI"),
    ("/swagger/v1/swagger.json", "Swagger JSON"),
    ("/api-docs", "API documentation"),
    ("/api/docs", "API documentation"),
    ("/api/v1/docs", "API v1 docs"),
    ("/openapi.json", "OpenAPI spec"),
    ("/redoc", "ReDoc API docs"),
    ("/wp-json/wp/v2/users", "WordPress user enumeration"),
    ("/api/config", "API configuration"),
    ("/api/debug", "API debug endpoint"),
    ("/api/admin", "API admin endpoint"),
    # Containers / Infra
    ("/haproxy?stats", "HAProxy stats"),
    ("/traefik", "Traefik dashboard"),
    ("/dashboard/", "Dashboard"),
    ("/v2/_catalog", "Docker Registry catalog"),
]


class DebugEndpointsPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="debug_endpoints",
        display_name="Debug Endpoint Finder",
        category=PluginCategory.PENTESTING,
        description="Discovers exposed debug, profiler, and monitoring endpoints",
        produces=["debug_endpoints"],
        timeout=30.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        found: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"debug_endpoints": []},
            )

        # Fetch SPA baseline (random path) to detect catch-all routing
        spa_baseline = ""
        try:
            async with ctx.rate:
                r = await ctx.http.get(
                    f"{base_url}/_nonexistent_path_8x7z/", timeout=5.0,
                )
                if r.status == 200:
                    spa_baseline = await r.text(
                        encoding="utf-8", errors="replace",
                    )
        except Exception:
            pass

        for path, desc in DEBUG_PATHS:
            url = f"{base_url}{path}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=5.0)
                    if resp.status == 200:
                        body = await resp.text(encoding="utf-8", errors="replace")

                        # Verify it's not a generic 404-as-200 page
                        if len(body) < 50:
                            continue
                        if "404" in body[:500] and "not found" in body[:500].lower():
                            continue

                        # Detect SPA catch-all (same body for any path)
                        if (
                            spa_baseline
                            and abs(len(body) - len(spa_baseline)) < 100
                            and body[:200] == spa_baseline[:200]
                        ):
                            continue

                        sev = "high" if any(
                            k in path for k in (
                                "actuator", "env", "heapdump", "profiler",
                                "console", "telescope", "threaddump",
                                "pprof", "swagger", "_catalog",
                            )
                        ) else "medium"

                        found.append({"path": path, "description": desc})
                        findings.append(getattr(Finding, sev)(
                            f"Debug endpoint exposed: {path}",
                            description=desc,
                            evidence=url,
                            remediation="Disable debug endpoints in production",
                            tags=["pentesting", "debug"],
                        ))
            except Exception:
                continue

        if not findings:
            findings.append(Finding.info(
                f"No debug endpoints found ({len(DEBUG_PATHS)} checked)",
                tags=["pentesting", "debug"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"debug_endpoints": found},
        )
