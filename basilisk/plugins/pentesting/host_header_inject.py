"""Host header injection detection."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target


class HostHeaderInjectPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="host_header_inject",
        display_name="Host Header Injection",
        category=PluginCategory.PENTESTING,
        description="Detects host header injection and web cache poisoning",
        produces=["host_inject_findings"],
        timeout=15.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={},
            )

        evil_host = "evil.basilisk.test"

        # Test 1: X-Forwarded-Host injection
        try:
            async with ctx.rate:
                resp = await ctx.http.get(
                    f"{base_url}/",
                    headers={"X-Forwarded-Host": evil_host},
                    timeout=8.0,
                )
                body = await resp.text(encoding="utf-8", errors="replace")
                if evil_host in body:
                    findings.append(Finding.medium(
                        "X-Forwarded-Host reflected in response",
                        description="Server reflects X-Forwarded-Host in page content",
                        evidence=f"Injected: {evil_host}",
                        remediation="Do not trust X-Forwarded-Host for URL generation",
                        tags=["pentesting", "host-injection"],
                    ))
        except Exception:
            pass

        # Test 2: X-Host header
        try:
            async with ctx.rate:
                resp = await ctx.http.get(
                    f"{base_url}/",
                    headers={"X-Host": evil_host},
                    timeout=8.0,
                )
                body = await resp.text(encoding="utf-8", errors="replace")
                if evil_host in body:
                    findings.append(Finding.medium(
                        "X-Host reflected in response",
                        evidence=f"Injected: {evil_host}",
                        remediation="Ignore X-Host header",
                        tags=["pentesting", "host-injection"],
                    ))
        except Exception:
            pass

        # Test 3: Duplicate Host header (via X-Forwarded-Host as proxy)
        try:
            async with ctx.rate:
                resp = await ctx.http.get(
                    f"{base_url}/",
                    headers={"X-Forwarded-For": "127.0.0.1", "X-Forwarded-Host": evil_host},
                    timeout=8.0,
                )
                location = resp.headers.get("Location", "")
                if evil_host in location:
                    findings.append(Finding.high(
                        "Host header injection in redirect",
                        description="Redirect Location uses injected host",
                        evidence=f"Location: {location}",
                        remediation="Use server-side configured hostname for redirects",
                        tags=["pentesting", "host-injection"],
                    ))
        except Exception:
            pass

        if not findings:
            findings.append(Finding.info(
                "No host header injection detected",
                tags=["pentesting", "host-injection"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"tested": True},
        )
