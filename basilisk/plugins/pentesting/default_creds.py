"""Default credentials checker for common services."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

# Common default credential pages and their indicators
DEFAULT_CRED_CHECKS = [
    # ── Web panels ────────────────────────────────────────────────────
    {
        "path": "/phpmyadmin/",
        "name": "phpMyAdmin",
        "indicator": "phpmyadmin",
    },
    {
        "path": "/adminer.php",
        "name": "Adminer",
        "indicator": "adminer",
    },
    {
        "path": "/solr/",
        "name": "Apache Solr",
        "indicator": "solr",
    },
    {
        "path": "/jenkins/",
        "name": "Jenkins",
        "indicator": "jenkins",
    },
    {
        "path": "/manager/html",
        "name": "Tomcat Manager",
        "indicator": "tomcat",
    },
    {
        "path": "/manager/status",
        "name": "Tomcat Status",
        "indicator": "tomcat",
    },
    {
        "path": "/host-manager/html",
        "name": "Tomcat Host Manager",
        "indicator": "tomcat",
    },
    {
        "path": "/_plugin/head/",
        "name": "Elasticsearch Head",
        "indicator": "elasticsearch",
    },
    {
        "path": "/_cluster/health",
        "name": "Elasticsearch Cluster",
        "indicator": "cluster_name",
    },
    {
        "path": "/kibana/",
        "name": "Kibana",
        "indicator": "kibana",
    },
    {
        "path": "/app/kibana",
        "name": "Kibana App",
        "indicator": "kibana",
    },
    {
        "path": "/grafana/",
        "name": "Grafana",
        "indicator": "grafana",
    },
    {
        "path": "/grafana/login",
        "name": "Grafana Login",
        "indicator": "grafana",
    },
    {
        "path": "/portainer/",
        "name": "Portainer",
        "indicator": "portainer",
    },
    {
        "path": "/prometheus/",
        "name": "Prometheus",
        "indicator": "prometheus",
    },
    {
        "path": "/prometheus/graph",
        "name": "Prometheus Graph",
        "indicator": "prometheus",
    },
    {
        "path": "/minio/",
        "name": "MinIO Console",
        "indicator": "minio",
    },
    {
        "path": "/minio/login",
        "name": "MinIO Login",
        "indicator": "minio",
    },
    # ── Network devices ───────────────────────────────────────────────
    {
        "path": "/cgi-bin/login",
        "name": "Cisco Web UI",
        "indicator": "cisco",
    },
    {
        "path": "/webfig/",
        "name": "MikroTik WebFig",
        "indicator": "mikrotik",
    },
    {
        "path": "/webfig/#/login",
        "name": "MikroTik Login",
        "indicator": "mikrotik",
    },
    {
        "path": "/",
        "name": "TP-Link Admin",
        "indicator": "tp-link",
    },
    {
        "path": "/login.html",
        "name": "Ubiquiti UniFi",
        "indicator": "ubnt",
    },
    {
        "path": "/login",
        "name": "Fortinet FortiGate",
        "indicator": "fortinet",
    },
    {
        "path": "/",
        "name": "Zyxel Admin",
        "indicator": "zyxel",
    },
    # ── Databases ─────────────────────────────────────────────────────
    {
        "path": "/mongo-express/",
        "name": "Mongo Express",
        "indicator": "mongo express",
    },
    {
        "path": "/redis-commander/",
        "name": "Redis Commander",
        "indicator": "redis commander",
    },
    {
        "path": "/_utils/",
        "name": "CouchDB Fauxton",
        "indicator": "fauxton",
    },
    {
        "path": "/_utils/#login",
        "name": "CouchDB Login",
        "indicator": "couchdb",
    },
    {
        "path": "/pgadmin4/",
        "name": "pgAdmin",
        "indicator": "pgadmin",
    },
    {
        "path": "/pgadmin4/login",
        "name": "pgAdmin Login",
        "indicator": "pgadmin",
    },
    # ── Monitoring ────────────────────────────────────────────────────
    {
        "path": "/zabbix/",
        "name": "Zabbix",
        "indicator": "zabbix",
    },
    {
        "path": "/nagios/",
        "name": "Nagios",
        "indicator": "nagios",
    },
    {
        "path": "/cacti/",
        "name": "Cacti",
        "indicator": "cacti",
    },
    {
        "path": "/netdata/",
        "name": "Netdata",
        "indicator": "netdata",
    },
    {
        "path": "/icingaweb2/",
        "name": "Icinga Web 2",
        "indicator": "icinga",
    },
    {
        "path": "/prtg/",
        "name": "PRTG Network Monitor",
        "indicator": "prtg",
    },
    # ── Message queues ────────────────────────────────────────────────
    {
        "path": "/rabbitmq/",
        "name": "RabbitMQ Management",
        "indicator": "rabbitmq",
    },
    {
        "path": "/api/whoami",
        "name": "RabbitMQ API",
        "indicator": "rabbitmq",
    },
    {
        "path": "/flower/",
        "name": "Celery Flower",
        "indicator": "flower",
    },
    # ── CMS ───────────────────────────────────────────────────────────
    {
        "path": "/wp-login.php",
        "name": "WordPress Login",
        "indicator": "wordpress",
    },
    {
        "path": "/wp-admin/",
        "name": "WordPress Admin",
        "indicator": "wordpress",
    },
    {
        "path": "/administrator/",
        "name": "Joomla Admin",
        "indicator": "joomla",
    },
    {
        "path": "/user/login",
        "name": "Drupal Login",
        "indicator": "drupal",
    },
    {
        "path": "/admin/",
        "name": "Magento Admin",
        "indicator": "magento",
    },
    # ── DevOps / Infrastructure ───────────────────────────────────────
    {
        "path": "/ui/",
        "name": "Consul UI",
        "indicator": "consul",
    },
    {
        "path": "/ui/vault/",
        "name": "HashiCorp Vault",
        "indicator": "vault",
    },
    {
        "path": "/v2/_catalog",
        "name": "Docker Registry",
        "indicator": "repositories",
    },
    {
        "path": "/api/v1/namespaces",
        "name": "Kubernetes Dashboard",
        "indicator": "namespace",
    },
    {
        "path": "/dashboard/",
        "name": "Kubernetes Dashboard UI",
        "indicator": "kubernetes",
    },
    {
        "path": "/v3/",
        "name": "Rancher API",
        "indicator": "rancher",
    },
    {
        "path": "/traefik/",
        "name": "Traefik Dashboard",
        "indicator": "traefik",
    },
    {
        "path": "/webmin/",
        "name": "Webmin",
        "indicator": "webmin",
    },
    {
        "path": "/cockpit/",
        "name": "Cockpit",
        "indicator": "cockpit",
    },
    # ── IoT / Cameras ─────────────────────────────────────────────────
    {
        "path": "/doc/page/login.asp",
        "name": "Hikvision Camera",
        "indicator": "hikvision",
    },
    {
        "path": "/ISAPI/System/deviceInfo",
        "name": "Hikvision ISAPI",
        "indicator": "hikvision",
    },
    {
        "path": "/RPC_Login",
        "name": "Dahua Camera",
        "indicator": "dahua",
    },
    {
        "path": "/axis-cgi/param.cgi",
        "name": "Axis Camera",
        "indicator": "axis",
    },
    # ── Mail ──────────────────────────────────────────────────────────
    {
        "path": "/zimbra/",
        "name": "Zimbra Webmail",
        "indicator": "zimbra",
    },
    {
        "path": "/mail/",
        "name": "Roundcube Webmail",
        "indicator": "roundcube",
    },
    {
        "path": "/postfixadmin/",
        "name": "Postfix Admin",
        "indicator": "postfixadmin",
    },
    # ── DevOps tools ──────────────────────────────────────────────────
    {
        "path": "/actuator",
        "name": "Spring Boot Actuator",
        "indicator": "actuator",
    },
    {
        "path": "/actuator/health",
        "name": "Spring Boot Health",
        "indicator": "status",
    },
    {
        "path": "/airflow/login",
        "name": "Apache Airflow",
        "indicator": "airflow",
    },
    {
        "path": "/home",
        "name": "Apache Airflow Home",
        "indicator": "airflow",
    },
    {
        "path": "/sonarqube/",
        "name": "SonarQube",
        "indicator": "sonarqube",
    },
    {
        "path": "/sessions/new",
        "name": "SonarQube Login",
        "indicator": "sonar",
    },
    {
        "path": "/#admin/repository",
        "name": "Nexus Repository",
        "indicator": "nexus",
    },
    {
        "path": "/service/rest/v1/status",
        "name": "Nexus API",
        "indicator": "nexus",
    },
    {
        "path": "/users/sign_in",
        "name": "GitLab Login",
        "indicator": "gitlab",
    },
    {
        "path": "/-/user_settings/profile",
        "name": "GitLab Profile",
        "indicator": "gitlab",
    },
    {
        "path": "/gogs/",
        "name": "Gogs",
        "indicator": "gogs",
    },
    {
        "path": "/gitea/",
        "name": "Gitea",
        "indicator": "gitea",
    },
    {
        "path": "/user/login",
        "name": "Gitea Login",
        "indicator": "gitea",
    },
]


class DefaultCredsPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="default_creds",
        display_name="Default Credentials Check",
        category=PluginCategory.PENTESTING,
        description="Detects services with potential default credentials",
        produces=["default_creds_findings"],
        timeout=30.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        found_services: list[dict] = []
        base_url = ""

        # Use pre-probed scheme from autonomous mode when available
        _pre = ctx.state.get("http_scheme", {}).get(target.host)
        if _pre:
            base_url = f"{_pre}://{target.host}"

        if not base_url:
            for scheme in ("https", "http"):
                try:
                    async with ctx.rate:
                        await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                        base_url = f"{scheme}://{target.host}"
                        break
                except Exception as e:
                    logger.debug("default_creds: %s", e)
                    continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"services": []},
            )

        # Fetch SPA baseline to detect catch-all routing
        spa_baseline = ""
        try:
            async with ctx.rate:
                r = await ctx.http.get(
                    f"{base_url}/_nonexistent_8x7z_test/", timeout=5.0,
                )
                if r.status == 200:
                    spa_baseline = await r.text(
                        encoding="utf-8", errors="replace",
                    )
        except Exception as e:
            logger.debug("default_creds: %s", e)

        for check in DEFAULT_CRED_CHECKS:
            if ctx.should_stop:
                break
            url = f"{base_url}{check['path']}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=5.0)
                    if resp.status in (200, 301, 302, 401):
                        body = ""
                        if resp.status == 200:
                            body = await resp.text(encoding="utf-8", errors="replace")

                        # Skip SPA catch-all responses
                        if (
                            resp.status == 200
                            and spa_baseline
                            and abs(len(body) - len(spa_baseline)) < 100
                            and body[:200] == spa_baseline[:200]
                        ):
                            continue

                        if resp.status == 200 and check["indicator"] in body.lower():
                            found_services.append({
                                "name": check["name"],
                                "path": check["path"],
                                "status": resp.status,
                            })
                            findings.append(Finding.high(
                                f"{check['name']} detected (may have default credentials)",
                                description=(
                                    f"{check['name']} is accessible and may "
                                    "be using default credentials"
                                ),
                                evidence=url,
                                remediation=(
                                    f"Change default credentials for {check['name']} "
                                    "and restrict access"
                                ),
                                tags=["pentesting", "default-creds"],
                            ))
                        elif resp.status == 401:
                            found_services.append({
                                "name": check["name"],
                                "path": check["path"],
                                "status": 401,
                            })
                            findings.append(Finding.info(
                                f"{check['name']} found but requires auth",
                                evidence=url,
                                tags=["pentesting", "default-creds"],
                            ))
            except Exception as e:
                logger.debug("default_creds: %s", e)
                continue

        if not findings:
            findings.append(Finding.info(
                f"No default-credential services found ({len(DEFAULT_CRED_CHECKS)} checked)",
                tags=["pentesting", "default-creds"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"services": found_services},
        )
