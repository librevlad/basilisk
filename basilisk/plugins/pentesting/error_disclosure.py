"""Error message information disclosure detection."""

from __future__ import annotations

import re
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target


class ErrorDisclosurePlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="error_disclosure",
        display_name="Error Information Disclosure",
        category=PluginCategory.PENTESTING,
        description="Triggers and analyzes error messages for information disclosure",
        produces=["error_findings"],
        timeout=20.0,
    )

    ERROR_TRIGGERS = [
        ("/?id='", "SQL quote"),
        ("/?id[]=1", "Array param"),
        ("/index.php%00", "Null byte"),
        ("/%2e%2e/%2e%2e/etc/passwd", "Path traversal"),
        ("/AAAAAAAAA" * 50, "Long URL"),
        ("/?<script>", "Script tag"),
        ("/test.aspx", "ASP.NET probe"),
        ("/test.php", "PHP probe"),
    ]

    DISCLOSURE_PATTERNS = [
        ("Server Path", r"(?:/var/www/|/home/\w+/|/srv/|C:\\\\inetpub|/usr/share/)[\w/\\.-]+"),
        ("Framework", r"(?:Laravel|Django|Rails|Express|Flask|Spring|ASP\.NET)\s*[\d.]*"),
        ("Database", r"(?:MySQL|PostgreSQL|SQLite|Oracle|MSSQL)\s*[\d.]*"),
        ("PHP Error", r"(?:Fatal error|Warning|Notice|Parse error):.*?in\s+\S+\s+on line\s+\d+"),
        ("Python Traceback", r"Traceback \(most recent call last\)"),
        ("Java Exception", r"(?:java\.\w+\.[\w.]+Exception|at\s+[\w.]+\([\w.]+:\d+\))"),
        ("Stack Frame", r"#\d+\s+\S+\s+called at\s+\["),
        ("Internal IP", r"\b(?:10|172\.(?:1[6-9]|2\d|3[01])|192\.168)\.\d+\.\d+\b"),
    ]

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        disclosures: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"disclosures": []},
            )

        seen: set[str] = set()
        for path, trigger_name in self.ERROR_TRIGGERS:
            url = f"{base_url}{path}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=8.0)
                    body = await resp.text(encoding="utf-8", errors="replace")

                    for name, pattern in self.DISCLOSURE_PATTERNS:
                        if name in seen:
                            continue
                        match = re.search(pattern, body)
                        if match:
                            seen.add(name)
                            disclosures.append({
                                "type": name,
                                "trigger": trigger_name,
                                "match": match.group()[:150],
                            })
                            sev = "medium" if name in (
                                "Server Path", "Internal IP", "PHP Error",
                                "Python Traceback", "Java Exception",
                            ) else "low"
                            findings.append(getattr(Finding, sev)(
                                f"Error discloses {name}",
                                description=f"Triggered by: {trigger_name}",
                                evidence=match.group()[:150],
                                remediation="Configure custom error pages, disable debug mode",
                                tags=["pentesting", "info-disclosure"],
                            ))
            except Exception:
                continue

        if not findings:
            findings.append(Finding.info(
                "No information disclosed in error messages",
                tags=["pentesting", "info-disclosure"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"disclosures": disclosures},
        )
