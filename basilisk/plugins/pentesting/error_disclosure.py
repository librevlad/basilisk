"""Error message information disclosure detection.

Triggers various error conditions and analyzes responses for:
1. Server paths (filesystem paths leaked in errors)
2. Framework/language/database version disclosure
3. Stack traces (PHP, Python, Java, .NET, Ruby)
4. Internal IP addresses
5. SQL queries in error messages
6. Debug mode indicators
"""

from __future__ import annotations

import re
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target


class ErrorDisclosurePlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="error_disclosure",
        display_name="Error Information Disclosure",
        category=PluginCategory.PENTESTING,
        description=(
            "Triggers errors and analyzes responses for information disclosure: "
            "paths, stack traces, versions, internal IPs, SQL queries"
        ),
        produces=["error_findings"],
        timeout=25.0,
    )

    ERROR_TRIGGERS = [
        # SQL injection probes
        ("/?id='", "SQL quote"),
        ("/?id=1%27%20OR%201%3D1", "SQLi probe"),
        ("/?id=-1", "Negative ID"),
        ("/?id=99999999", "Large ID"),
        ("/?id=1 UNION SELECT 1--", "UNION SQLi probe"),
        # Parameter manipulation
        ("/?id[]=1", "Array param"),
        ("/?id=1%00", "Null byte param"),
        ("/?<script>", "Script tag"),
        ("/?q={{7*7}}", "SSTI probe"),
        ("/?q=${7*7}", "SSTI expression probe"),
        ("/?callback=test", "JSONP callback probe"),
        # Path traversal / file inclusion
        ("/index.php%00", "Null byte path"),
        ("/%2e%2e/%2e%2e/etc/passwd", "Path traversal"),
        ("/wp-content/../wp-config.php", "WP config traverse"),
        ("/.env", "Dotenv probe"),
        ("/.git/HEAD", "Git HEAD probe"),
        ("/server-status", "Apache status probe"),
        ("/server-info", "Apache info probe"),
        # Long / malformed URL
        ("/" + "A" * 500, "Long URL"),
        ("/%00", "Null byte root"),
        ("/;", "Semicolon path"),
        # Framework-specific probes
        ("/test.aspx", "ASP.NET probe"),
        ("/test.php", "PHP probe"),
        ("/test.jsp", "JSP probe"),
        ("/test.do", "Struts action probe"),
        ("/actuator/env", "Spring Actuator env"),
        ("/trace", "Spring trace endpoint"),
        ("/elmah.axd", "ELMAH error log probe"),
        # Debug / error pages
        ("/index.php?debug=1", "Debug flag"),
        ("/index.php?test=true", "Test flag"),
        ("/?_debug=1", "Underscore debug flag"),
        ("/_debugbar/open", "Laravel Debugbar probe"),
        ("/error", "Error page"),
        ("/404", "Custom 404"),
        ("/undefined", "Undefined route"),
        ("/api/v1/../../", "API path traversal"),
        # Content-type manipulation
        ("/?format=xml", "Format XML probe"),
        ("/?format=json", "Format JSON probe"),
    ]

    DISCLOSURE_PATTERNS = [
        # ── Path and environment disclosure ──────────────────────────
        (
            "Server Path",
            r"(?:/var/www/|/home/\w+/|/srv/|/opt/|C:\\\\?(?:inetpub|Users|Windows)"
            r"|/usr/(?:share|local|lib)/)[\w/\\.-]+",
        ),
        (
            "Internal IP",
            r"\b(?:10\.\d{1,3}\.\d{1,3}\.\d{1,3}"
            r"|172\.(?:1[6-9]|2\d|3[01])\.\d{1,3}\.\d{1,3}"
            r"|192\.168\.\d{1,3}\.\d{1,3})\b",
        ),
        (
            "Email Address",
            r"\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b",
        ),
        (
            "Debug Mode",
            r"(?:DEBUG\s*(?:=|:)\s*(?:true|True|1|on)|WP_DEBUG|DJANGO_DEBUG"
            r"|APP_DEBUG\s*=\s*true)",
        ),
        # ── Framework-specific errors ────────────────────────────────
        (
            "Framework",
            r"(?:Laravel|Django|Rails|Express|Flask|FastAPI|Spring(?:Boot)?|ASP\.NET"
            r"|Next\.js|Nuxt|CakePHP|CodeIgniter|Symfony)\s*[\d.]*",
        ),
        (
            "Laravel Error",
            r"(?:Whoops!?\s*(?:Looks like something went wrong|There was an error)"
            r"|Illuminate\\\\[\w\\\\]+Exception)",
        ),
        (
            "Symfony Error",
            r"(?:Symfony\\\\Component\\\\[\w\\\\]+Exception"
            r"|Symfony\s+Exception|kernel\.debug\s*=)",
        ),
        (
            "CakePHP Error",
            r"(?:CakePHP.*(?:Error|Exception)|Missing\s+Controller"
            r"|Missing\s+(?:Action|View|Layout))",
        ),
        (
            "CodeIgniter Error",
            r"A\s+PHP\s+Error\s+was\s+encountered",
        ),
        (
            "Yii Error",
            r"(?:Yii\s+Framework|yii\\\\[\w\\\\]+Exception"
            r"|CHttpException)",
        ),
        (
            "Slim Error",
            r"Slim\s+Application\s+Error",
        ),
        (
            "Phoenix Error",
            r"(?:Phoenix\.Router\.NoRouteError"
            r"|%Protocol\.UndefinedError)",
        ),
        (
            "Go Error",
            r"(?:goroutine\s+\d+\s+\[|runtime/debug\.Stack"
            r"|runtime\.gopanic)",
        ),
        (
            "Rust Panic",
            r"thread\s+'(?:main|\w+)'\s+panicked\s+at",
        ),
        # ── Language-specific errors ─────────────────────────────────
        (
            "PHP Error",
            r"(?:Fatal error|Warning|Notice|Parse error|Deprecated):\s*.+?"
            r"in\s+\S+\s+on line\s+\d+",
        ),
        (
            "Python Traceback",
            r"Traceback \(most recent call last\)",
        ),
        (
            "Java Exception",
            r"(?:java\.\w+\.[\w.]+Exception|at\s+[\w.$]+\([\w.]+:\d+\))",
        ),
        (
            ".NET Exception",
            r"(?:System\.\w+Exception|Server Error in .+ Application"
            r"|An unhandled exception)",
        ),
        (
            "Ruby Error",
            r"(?:NoMethodError|ArgumentError|NameError|RuntimeError)"
            r"\s*[\(:]",
        ),
        (
            "Node.js Error",
            r"(?:TypeError|ReferenceError|SyntaxError|RangeError)"
            r"\s*:.*at\s+",
        ),
        (
            "SQL Query",
            r"(?:SELECT\s+.+?\s+FROM|INSERT\s+INTO|UPDATE\s+.+?\s+SET"
            r"|DELETE\s+FROM)\s+\w+",
        ),
        (
            "Stack Frame",
            r"#\d+\s+\S+\s+(?:called at|in)\s+",
        ),
        # ── Database-specific errors ─────────────────────────────────
        (
            "Database Error",
            r"(?:MySQL|PostgreSQL|SQLite|Oracle|MSSQL|MariaDB|MongoDB)"
            r"(?:\s+(?:server|version))?\s*[\d.]*",
        ),
        (
            "Redis Error",
            r"(?:WRONGTYPE\s+Operation|RedisException"
            r"|redis\.exceptions\.\w+Error)",
        ),
        (
            "Cassandra Error",
            r"(?:com\.datastax\.[\w.]+Exception"
            r"|cassandra\.cluster\.NoHostAvailable)",
        ),
        (
            "Elasticsearch Error",
            r"(?:ElasticsearchException|SearchPhaseExecutionException"
            r"|index_not_found_exception)",
        ),
        (
            "Neo4j Error",
            r"(?:org\.neo4j\.[\w.]+Exception"
            r"|Neo\.ClientError\.\w+)",
        ),
        # ── Cloud / infrastructure errors ────────────────────────────
        (
            "AWS Error",
            r"(?:AccessDenied|InvalidAccessKeyId|NoSuchBucket"
            r"|NoSuchKey|SignatureDoesNotMatch"
            r"|The\s+security\s+token\s+included\s+in\s+the\s+request\s+is\s+invalid)",
        ),
        (
            "Azure Error",
            r"(?:AZURE_[\w]+\s*=|AzureWebJobsStorage"
            r"|Microsoft\.Azure\.[\w.]+Exception"
            r"|The\s+specified\s+resource\s+does\s+not\s+exist)",
        ),
        (
            "GCP Error",
            r"(?:google\.api_core\.exceptions\.\w+"
            r"|Google\s+Cloud\s+Error|GOOGLE_APPLICATION_CREDENTIALS)",
        ),
        (
            "Docker Exposure",
            r"(?:docker-compose[\w.-]*\.ya?ml|DOCKER_HOST\s*="
            r"|Cannot\s+connect\s+to\s+the\s+Docker\s+daemon)",
        ),
        # ── Sensitive data patterns ──────────────────────────────────
        (
            "Connection String",
            r"(?:mongodb(?:\+srv)?://|redis://|mysql://|postgresql://"
            r"|amqp://|jdbc:[\w:]+//)\S+",
        ),
        (
            "API Key Leak",
            r"(?:sk_live_[\w]{20,}|pk_live_[\w]{20,}"
            r"|AKIA[0-9A-Z]{16})",
        ),
        (
            "JWT Token",
            r"eyJ[A-Za-z0-9_-]{10,}\.eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]+",
        ),
        (
            "Environment Variable",
            r"(?:DATABASE_URL|SECRET_KEY|API_KEY|PRIVATE_KEY"
            r"|AWS_SECRET_ACCESS_KEY|STRIPE_SECRET)\s*=\s*\S+",
        ),
        # ── Additional disclosure patterns ───────────────────────────
        (
            "Spring Actuator",
            r"(?:\"spring\.datasource|\"spring\.jpa\"|actuator/env"
            r"|management\.endpoints)",
        ),
        (
            "LDAP Disclosure",
            r"(?:ldap://[\w.:]+|LDAP\s+Error\s+Code"
            r"|javax\.naming\.[\w.]+Exception)",
        ),
        (
            "XML Parser Error",
            r"(?:SAXParseException|XMLSyntaxError"
            r"|org\.xml\.sax\.SAXException|lxml\.etree\.XMLSyntaxError)",
        ),
        (
            "Server Version",
            r"(?:Apache/[\d.]+|nginx/[\d.]+|Microsoft-IIS/[\d.]+"
            r"|PHP/[\d.]+|OpenSSL/[\d.a-z]+)",
        ),
        (
            "WordPress Debug",
            r"(?:wp-config\.php|WP_DEBUG_DISPLAY|WP_SITEURL"
            r"|table_prefix\s*=)",
        ),
        (
            "Django Settings",
            r"(?:INSTALLED_APPS|MIDDLEWARE_CLASSES|DATABASES\s*="
            r"|SECRET_KEY\s*=\s*['\"])",
        ),
        (
            "Source Code Fragment",
            r"(?:<?php\s|def\s+\w+\s*\(|class\s+\w+\s*(?:\(|:)"
            r"|function\s+\w+\s*\()",
        ),
        (
            "Kubernetes Config",
            r"(?:KUBERNETES_SERVICE_HOST|kube-system"
            r"|serviceAccountName|kubectl\s+)",
        ),
    ]

    # High-severity patterns
    HIGH_SEVERITY = {
        "Server Path", "Internal IP", "PHP Error", "Python Traceback",
        "Java Exception", ".NET Exception", "SQL Query", "Debug Mode",
        "Connection String", "API Key Leak", "JWT Token", "Environment Variable",
        "AWS Error", "Azure Error", "GCP Error", "Docker Exposure",
        "Go Error", "Rust Panic", "Laravel Error",
        "Django Settings", "WordPress Debug", "Kubernetes Config",
        "Source Code Fragment",
    }

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available",
            )

        from basilisk.utils.http_check import resolve_base_url

        findings: list[Finding] = []
        disclosures: list[dict] = []

        base_url = await resolve_base_url(target.host, ctx)
        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"disclosures": []},
            )

        # Get baseline body to filter out normal page content
        baseline_body = ""
        try:
            async with ctx.rate:
                resp = await ctx.http.get(f"{base_url}/", timeout=5.0)
                baseline_body = await resp.text(encoding="utf-8", errors="replace")
        except Exception:
            pass

        seen: set[str] = set()
        for path, trigger_name in self.ERROR_TRIGGERS:
            if ctx.should_stop or len(disclosures) >= 10:
                break

            url = f"{base_url}{path}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=8.0)
                    body = await resp.text(encoding="utf-8", errors="replace")

                    for name, pattern in self.DISCLOSURE_PATTERNS:
                        if name in seen:
                            continue
                        match = re.search(pattern, body, re.IGNORECASE)
                        if not match:
                            continue

                        # Skip if the same match exists in baseline
                        if baseline_body and re.search(
                            pattern, baseline_body, re.IGNORECASE,
                        ):
                            continue

                        seen.add(name)
                        matched_text = match.group()[:150]
                        disclosures.append({
                            "type": name,
                            "trigger": trigger_name,
                            "match": matched_text,
                        })

                        sev = Finding.medium if name in self.HIGH_SEVERITY else Finding.low
                        findings.append(sev(
                            f"Error discloses {name}",
                            description=f"Triggered by: {trigger_name}",
                            evidence=matched_text,
                            remediation=(
                                "Configure custom error pages, disable debug mode, "
                                "suppress detailed error messages in production."
                            ),
                            tags=["pentesting", "info-disclosure", name.lower().replace(" ", "-")],
                        ))
            except Exception:
                continue

        if not findings:
            findings.append(Finding.info(
                f"No information disclosed in error messages "
                f"({len(self.ERROR_TRIGGERS)} triggers tested)",
                tags=["pentesting", "info-disclosure"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"disclosures": disclosures},
        )
