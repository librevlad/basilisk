"""Open redirect detection."""

from __future__ import annotations

from typing import ClassVar
from urllib.parse import quote

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

REDIRECT_PARAMS = [
    "url", "redirect", "redirect_url", "redirect_uri", "return",
    "return_url", "returnTo", "next", "target", "rurl", "dest",
    "destination", "redir", "redirect_to", "out", "view", "to",
    "continue", "ref", "site", "goto",
]

REDIRECT_TARGET = "https://evil.com"


class OpenRedirectPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="open_redirect",
        display_name="Open Redirect Scanner",
        category=PluginCategory.PENTESTING,
        description="Detects open redirect vulnerabilities",
        produces=["redirect_findings"],
        timeout=30.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        tested: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"redirect_tests": []},
            )

        payloads = [
            REDIRECT_TARGET,
            "//evil.com",
            "/\\evil.com",
            "///evil.com",
        ]

        for param in REDIRECT_PARAMS:
            for payload in payloads:
                url = f"{base_url}/?{param}={quote(payload)}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(
                            url, allow_redirects=False, timeout=8.0,
                        )
                        location = resp.headers.get("Location", "")

                        if resp.status in (301, 302, 303, 307, 308) and "evil.com" in location:
                                tested.append({
                                    "param": param, "payload": payload,
                                    "location": location,
                                })
                                findings.append(Finding.medium(
                                    f"Open redirect via ?{param}=",
                                    description=(
                                        "Server redirects to attacker-controlled URL"
                                    ),
                                    evidence=f"Location: {location}",
                                    remediation=(
                                        "Validate redirect URLs against a whitelist"
                                    ),
                                    tags=["pentesting", "open-redirect"],
                                ))
                                break
                except Exception:
                    continue
            if findings:
                break

        if not findings:
            findings.append(Finding.info(
                "No open redirect vulnerabilities detected",
                tags=["pentesting", "open-redirect"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"redirect_tests": tested},
        )
