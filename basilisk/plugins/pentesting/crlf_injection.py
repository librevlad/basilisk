"""CRLF injection detection."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target


class CrlfInjectionPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="crlf_injection",
        display_name="CRLF Injection Scanner",
        category=PluginCategory.PENTESTING,
        description="Detects CRLF injection in HTTP headers",
        produces=["crlf_findings"],
        timeout=15.0,
    )

    CANARY = "X-CRLF-Test"

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        tested: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"crlf_tests": []},
            )

        payloads = [
            f"%0d%0a{self.CANARY}:%20injected",
            f"%0D%0A{self.CANARY}:%20injected",
            f"\\r\\n{self.CANARY}:%20injected",
            f"%E5%98%8A%E5%98%8D{self.CANARY}:%20injected",
        ]

        test_params = ["url", "redirect", "path", "next", "return"]

        for param in test_params:
            for payload in payloads:
                url = f"{base_url}/?{param}={payload}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(
                            url, allow_redirects=False, timeout=8.0,
                        )

                        if self.CANARY.lower() in {
                            k.lower() for k in resp.headers
                        }:
                            tested.append({
                                "param": param, "payload": payload,
                            })
                            findings.append(Finding.high(
                                f"CRLF injection via ?{param}=",
                                description="Server reflects injected headers (CRLF)",
                                evidence=f"Injected header: {self.CANARY}",
                                remediation="Sanitize CRLF characters in all user input",
                                tags=["pentesting", "crlf"],
                            ))
                            break
                except Exception:
                    continue
            if findings:
                break

        if not findings:
            findings.append(Finding.info(
                "No CRLF injection detected",
                tags=["pentesting", "crlf"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"crlf_tests": tested},
        )
