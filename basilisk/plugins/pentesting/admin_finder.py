"""Admin panel finder — discovers administrative interfaces."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

ADMIN_PATHS = [
    # Generic admin
    "/admin", "/admin/", "/administrator", "/administrator/",
    "/admin/login", "/admin.php", "/admin/index.php",
    "/admin/dashboard", "/admin/config",
    "/panel", "/panel/", "/cpanel", "/cpanel/",
    "/webadmin", "/webadmin/",
    "/dashboard", "/dashboard/",
    "/manage", "/management", "/manager",
    "/backend", "/backoffice",
    "/controlpanel", "/admincp",
    "/_admin", "/admin_area", "/adminpanel",
    "/siteadmin", "/site-admin",
    "/cms", "/cms/admin",
    # Auth pages
    "/login", "/login/", "/signin", "/sign-in",
    "/auth", "/auth/login", "/auth/signin",
    "/user/login", "/account/login",
    "/accounts/login", "/members/login",
    # WordPress
    "/wp-admin", "/wp-admin/", "/wp-login.php",
    # Joomla
    "/administrator/index.php",
    # Drupal
    "/user", "/user/login",
    # 1C-Bitrix
    "/bitrix/admin", "/bitrix/admin/",
    # MODX
    "/modx/", "/modx/manager/",
    # Database tools
    "/phpmyadmin", "/phpmyadmin/", "/pma", "/pma/",
    "/adminer", "/adminer.php",
    "/dbadmin", "/mysqladmin", "/pgadmin",
    # CMS-specific
    "/ghost/", "/ghost/signin",
    "/strapi/", "/strapi/admin",
    "/keystone/", "/directus/admin",
    "/cockpit/", "/craft/admin",
    # API admin
    "/api/admin", "/api/v1/admin",
    "/graphql/admin",
]


class AdminFinderPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="admin_finder",
        display_name="Admin Panel Finder",
        category=PluginCategory.PENTESTING,
        description="Discovers admin panels and login pages",
        produces=["admin_panels"],
        timeout=30.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        found: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"admin_panels": []},
            )

        # Fetch SPA baseline to detect catch-all routing
        spa_baseline = ""
        try:
            async with ctx.rate:
                r = await ctx.http.get(
                    f"{base_url}/_nonexistent_8x7z_admin/", timeout=5.0,
                )
                if r.status == 200:
                    spa_baseline = await r.text(
                        encoding="utf-8", errors="replace",
                    )
        except Exception:
            pass

        for path in ADMIN_PATHS:
            url = f"{base_url}{path}"
            try:
                async with ctx.rate:
                    resp = await ctx.http.get(url, timeout=5.0)
                    if resp.status in (200, 301, 302):
                        body = await resp.text(encoding="utf-8", errors="replace")

                        # Skip SPA catch-all responses
                        if (
                            resp.status == 200
                            and spa_baseline
                            and abs(len(body) - len(spa_baseline)) < 100
                            and body[:200] == spa_baseline[:200]
                        ):
                            continue

                        has_login = any(
                            kw in body.lower()
                            for kw in ("password", "login", "sign in", "авторизация", "вход")
                        )
                        found.append({
                            "path": path, "status": resp.status,
                            "has_login": has_login,
                        })

                        if has_login:
                            findings.append(Finding.medium(
                                f"Admin login page: {path}",
                                description="Admin login page accessible without restriction",
                                evidence=url,
                                remediation="Restrict admin access by IP or add 2FA",
                                tags=["pentesting", "admin"],
                            ))
                        elif resp.status == 200:
                            findings.append(Finding.low(
                                f"Admin path accessible: {path}",
                                evidence=f"{url} → {resp.status}",
                                tags=["pentesting", "admin"],
                            ))
            except Exception:
                continue

        if not findings:
            findings.append(Finding.info(
                f"No admin panels found ({len(ADMIN_PATHS)} paths checked)",
                tags=["pentesting", "admin"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"admin_panels": found, "paths_checked": len(ADMIN_PATHS)},
        )
