"""Network enumeration â€” interfaces, routes, ARP, hosts file."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)


class NetworkEnumPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="network_enum",
        display_name="Network Enumeration",
        category=PluginCategory.POST_EXPLOIT,
        description="Interfaces, routes, ARP, hosts file, DNS config",
        produces=["network_info"],
        timeout=30.0,
        requires_http=False,
        requires_shell=True,
        risk_level="safe",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []
        data: dict = {
            "interfaces": "", "routes": "", "arp": "",
            "hosts": "", "dns": "", "subnets": [],
        }

        shells = ctx.state.get("active_shells", [])
        if not shells or not ctx.shell:
            return PluginResult.fail(
                self.meta.name, target.host, error="No shell session",
            )

        session = (
            ctx.shell.get_session(shells[0]["id"])
            if isinstance(shells[0], dict) else None
        )
        if not session:
            return PluginResult.fail(
                self.meta.name, target.host, error="Shell session not found",
            )

        from basilisk.utils.shell import ShellOS
        is_windows = session.os == ShellOS.WINDOWS

        if is_windows:
            cmds = {
                "interfaces": "ipconfig /all",
                "routes": "route print",
                "arp": "arp -a",
                "hosts": "type C:\\Windows\\System32\\drivers\\etc\\hosts",
                "dns": "ipconfig /displaydns 2>nul | findstr Record",
                "firewall": "netsh advfirewall show allprofiles state",
            }
        else:
            cmds = {
                "interfaces": "ip addr 2>/dev/null || ifconfig 2>/dev/null",
                "routes": "ip route 2>/dev/null || route -n 2>/dev/null",
                "arp": "ip neigh 2>/dev/null || arp -a 2>/dev/null",
                "hosts": "cat /etc/hosts 2>/dev/null",
                "dns": "cat /etc/resolv.conf 2>/dev/null",
                "firewall": "iptables -L -n 2>/dev/null | head -30",
            }

        for name, cmd in cmds.items():
            if ctx.should_stop:
                break
            output = await ctx.shell.execute(session, cmd, timeout=10.0)
            if output:
                data[name] = output[:2000]

        # Report interfaces
        if data["interfaces"]:
            findings.append(Finding.info(
                "Network interfaces enumerated",
                evidence=data["interfaces"][:500],
                tags=["post-exploit", "network"],
            ))

            # Extract subnets for pivot targets
            lines = data["interfaces"].splitlines()
            for line in lines:
                for keyword in ["inet ", "IPv4", "IP Address"]:
                    if keyword in line and "127.0.0.1" not in line:
                        data["subnets"].append(line.strip())

        # Hosts file may reveal internal hostnames
        if data["hosts"]:
            host_entries = [
                line for line in data["hosts"].splitlines()
                if line.strip() and not line.strip().startswith("#")
            ]
            if host_entries:
                findings.append(Finding.medium(
                    f"Hosts file entries: {len(host_entries)}",
                    evidence="\n".join(host_entries[:20]),
                    description="May reveal internal hostnames and IPs",
                    tags=["post-exploit", "network", "hosts"],
                ))

        # Routes for pivoting
        if data["routes"]:
            findings.append(Finding.info(
                "Routing table enumerated",
                evidence=data["routes"][:500],
                tags=["post-exploit", "network", "routes"],
            ))

        if data["subnets"]:
            findings.append(Finding.medium(
                f"Network subnets discovered: {len(data['subnets'])}",
                evidence="\n".join(data["subnets"][:10]),
                description="Potential pivot targets for lateral movement",
                tags=["post-exploit", "network", "pivot"],
            ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )
