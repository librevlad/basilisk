"""User enumeration â€” users, groups, last login, logged-in users."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)


class UserEnumPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="user_enum",
        display_name="User Enumeration",
        category=PluginCategory.POST_EXPLOIT,
        description="Users, groups, last login, logged-in users",
        produces=["users"],
        timeout=30.0,
        requires_http=False,
        requires_shell=True,
        risk_level="safe",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []
        data: dict = {
            "current_user": "", "users": [], "groups": [],
            "logged_in": [], "last_login": [],
        }

        shells = ctx.state.get("active_shells", [])
        if not shells or not ctx.shell:
            return PluginResult.fail(
                self.meta.name, target.host, error="No shell session",
            )

        session = (
            ctx.shell.get_session(shells[0]["id"])
            if isinstance(shells[0], dict) else None
        )
        if not session:
            return PluginResult.fail(
                self.meta.name, target.host, error="Shell session not found",
            )

        from basilisk.utils.shell import ShellOS
        is_windows = session.os == ShellOS.WINDOWS

        if is_windows:
            await self._enum_windows(session, ctx, findings, data)
        else:
            await self._enum_linux(session, ctx, findings, data)

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )

    async def _enum_linux(self, session, ctx, findings, data) -> None:
        # Current user
        whoami = await ctx.shell.execute(session, "id", timeout=5.0)
        if whoami:
            data["current_user"] = whoami.strip()
            findings.append(Finding.info(
                f"Current user: {whoami.strip()[:80]}",
                evidence=whoami, tags=["post-exploit", "user"],
            ))
            if "uid=0" in whoami:
                findings.append(Finding.critical(
                    "Running as root",
                    evidence=whoami, tags=["post-exploit", "root"],
                ))

        # All users with shell access
        passwd = await ctx.shell.execute(
            session,
            "cat /etc/passwd 2>/dev/null | grep -v nologin | grep -v /false",
            timeout=5.0,
        )
        if passwd:
            data["users"] = passwd.strip().splitlines()

        # Groups
        groups = await ctx.shell.execute(
            session, "cat /etc/group 2>/dev/null", timeout=5.0,
        )
        if groups:
            data["groups"] = groups.strip().splitlines()[:50]

        # Currently logged in
        w_output = await ctx.shell.execute(session, "w 2>/dev/null", timeout=5.0)
        if w_output:
            data["logged_in"] = w_output.strip().splitlines()

        # Last logins
        last_output = await ctx.shell.execute(
            session, "last -20 2>/dev/null", timeout=5.0,
        )
        if last_output:
            data["last_login"] = last_output.strip().splitlines()

        # Home directories
        homes = await ctx.shell.execute(
            session, "ls -la /home/ 2>/dev/null", timeout=5.0,
        )
        if homes:
            findings.append(Finding.info(
                "Home directories enumerated",
                evidence=homes[:500], tags=["post-exploit", "user"],
            ))

    async def _enum_windows(self, session, ctx, findings, data) -> None:
        whoami = await ctx.shell.execute(session, "whoami /all", timeout=10.0)
        if whoami:
            data["current_user"] = whoami.strip()[:200]
            findings.append(Finding.info(
                f"Current user: {whoami.strip().splitlines()[0][:80]}",
                evidence=whoami[:500], tags=["post-exploit", "user"],
            ))
            if "BUILTIN\\Administrators" in whoami:
                findings.append(Finding.critical(
                    "User is a local administrator",
                    evidence=whoami[:300],
                    tags=["post-exploit", "admin"],
                ))

        users = await ctx.shell.execute(session, "net user", timeout=5.0)
        if users:
            data["users"] = users.strip().splitlines()

        groups = await ctx.shell.execute(
            session, "net localgroup", timeout=5.0,
        )
        if groups:
            data["groups"] = groups.strip().splitlines()

        logged = await ctx.shell.execute(
            session, "query user 2>nul", timeout=5.0,
        )
        if logged:
            data["logged_in"] = logged.strip().splitlines()
