"""CVE exploit matcher — version_detect → known exploits database."""

from __future__ import annotations

import logging
import re
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

# CVE database: (product_regex, version_range, cve, severity, description)
CVE_DB: list[tuple[str, str, str, str, str]] = [
    # Apache
    (r"apache.*2\.4\.49", "=2.4.49", "CVE-2021-41773", "critical",
     "Apache 2.4.49 Path Traversal + RCE"),
    (r"apache.*2\.4\.50", "=2.4.50", "CVE-2021-42013", "critical",
     "Apache 2.4.50 Path Traversal bypass"),
    (r"apache.*2\.4\.(0|[1-3]\d|4[0-8])\b", "<2.4.49", "CVE-2021-44790", "high",
     "Apache mod_lua buffer overflow"),
    # Nginx
    (r"nginx.*1\.(1[0-7]|[0-9])\.", "<1.18", "CVE-2021-23017", "high",
     "Nginx DNS resolver vulnerability"),
    # OpenSSH
    (r"openssh.*[78]\.[0-7]", "<8.8", "CVE-2021-41617", "medium",
     "OpenSSH privilege escalation"),
    (r"openssh.*8\.([0-7])\b", "<8.8", "CVE-2023-38408", "high",
     "OpenSSH PKCS#11 RCE (forwarded agent)"),
    # PHP
    (r"php.*8\.1\.0-dev", "=8.1.0-dev", "Backdoor", "critical",
     "PHP 8.1.0-dev backdoor RCE (zerodium)"),
    (r"php.*(5\.[0-6]|7\.[0-3])", "<7.4", "CVE-2019-11043", "critical",
     "PHP-FPM RCE"),
    # WordPress
    (r"wordpress.*([0-4]\.\d|5\.[0-7])\b", "<5.8", "Multiple", "high",
     "WordPress <5.8 multiple vulnerabilities"),
    # Drupal
    (r"drupal.*[78]\.", "<9.0", "CVE-2019-6340", "critical",
     "Drupalgeddon3 RCE"),
    (r"drupal.*(7\.\d+)", "<8.0", "CVE-2018-7600", "critical",
     "Drupalgeddon2 RCE"),
    # jQuery
    (r"jquery.*[12]\.", "<3.0", "CVE-2020-11022", "medium",
     "jQuery XSS via HTML injection"),
    # Tomcat
    (r"tomcat.*[89]\.[05]\.(0|[1-3]\d)", "<9.0.35", "CVE-2020-1938", "critical",
     "Apache Tomcat Ghostcat AJP RCE"),
    (r"tomcat.*8\.5\.(0|[1-2]\d)", "<8.5.30", "CVE-2017-12617", "high",
     "Tomcat PUT RCE"),
    # Jenkins
    (r"jenkins.*2\.\d{1,2}\b", "<2.300", "CVE-2019-1003000", "critical",
     "Jenkins Script Console RCE"),
    # ProFTPD
    (r"proftpd.*1\.3\.[0-5]", "<1.3.6", "CVE-2019-12815", "critical",
     "ProFTPD mod_copy arbitrary file copy"),
    # vsftpd
    (r"vsftpd.*2\.3\.4", "=2.3.4", "Backdoor", "critical",
     "vsftpd 2.3.4 backdoor (smiley face)"),
    # Exim
    (r"exim.*4\.([0-8]\d|9[0-1])", "<4.92", "CVE-2019-10149", "critical",
     "Exim RCE (Return of the WIZard)"),
    # Samba
    (r"samba.*[34]\.[0-5]", "<4.6", "CVE-2017-7494", "critical",
     "SambaCry RCE (EternalRed)"),
    # Spring
    (r"spring.*5\.[0-2]", "<5.3", "CVE-2022-22965", "critical",
     "Spring4Shell RCE"),
    # Log4j
    (r"log4j.*2\.(0|[1-9]|1[0-6])\b", "<2.17", "CVE-2021-44228", "critical",
     "Log4Shell RCE"),
    # GitLab
    (r"gitlab.*1[0-3]\.", "<14.0", "CVE-2021-22205", "critical",
     "GitLab ExifTool RCE"),
    # Confluence
    (r"confluence.*[67]\.", "<7.13", "CVE-2022-26134", "critical",
     "Confluence OGNL injection RCE"),
    # Grafana
    (r"grafana.*[78]\.", "<8.3.1", "CVE-2021-43798", "high",
     "Grafana path traversal (file read)"),
]


class CveExploitPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="cve_exploit",
        display_name="CVE Exploit Matcher",
        category=PluginCategory.EXPLOITATION,
        description="Match detected versions against CVE exploit database",
        depends_on=["version_detect"],
        produces=["cve_matches"],
        timeout=30.0,
        requires_http=False,
        risk_level="safe",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []
        data: dict = {"cves": []}

        # Get version data from previous plugins
        version_result = ctx.pipeline.get(f"version_detect:{target.host}")
        tech_result = ctx.pipeline.get(f"tech_detect:{target.host}")

        versions: list[str] = []
        if version_result and version_result.ok:
            for v in version_result.data.get("versions", []):
                versions.append(f"{v.get('product', '')} {v.get('version', '')}")
        if tech_result and tech_result.ok:
            for tech in tech_result.data.get("technologies", []):
                if tech.get("version"):
                    versions.append(f"{tech['name']} {tech['version']}")

        # Also check service_detect results
        service_result = ctx.pipeline.get(f"service_detect:{target.host}")
        if service_result and service_result.ok:
            for svc in service_result.data.get("services", []):
                if svc.get("version"):
                    versions.append(f"{svc['product']} {svc['version']}")

        # Also check banner data from port_scan
        port_result = ctx.pipeline.get(f"port_scan:{target.host}")
        if port_result and port_result.ok:
            for banner in port_result.data.get("banners", {}).values():
                if banner:
                    versions.append(banner)

        if not versions:
            findings.append(Finding.info(
                "No version information available for CVE matching",
                tags=["cve"],
            ))
            return PluginResult.success(
                self.meta.name, target.host, findings=findings, data=data,
            )

        # Match against CVE database
        matched_cves: set[str] = set()
        version_text = "\n".join(versions).lower()

        for pattern, _ver_range, cve, severity, description in CVE_DB:
            if cve in matched_cves:
                continue
            if re.search(pattern, version_text, re.IGNORECASE):
                matched_cves.add(cve)
                data["cves"].append({
                    "cve": cve, "severity": severity,
                    "description": description,
                })

                finding_fn = {
                    "critical": Finding.critical,
                    "high": Finding.high,
                    "medium": Finding.medium,
                }.get(severity, Finding.info)

                findings.append(finding_fn(
                    f"{cve}: {description}",
                    evidence=f"Matched pattern: {pattern}\nVersions: {version_text[:300]}",
                    description=f"Potential vulnerability: {description}",
                    remediation=f"Update affected software. Reference: {cve}",
                    tags=["cve", severity],
                ))

        if not matched_cves:
            findings.append(Finding.info(
                "No known CVEs matched detected versions",
                tags=["cve"],
            ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )
