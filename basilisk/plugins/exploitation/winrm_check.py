"""WinRM authentication check with discovered credentials."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)


class WinrmCheckPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="winrm_check",
        display_name="WinRM Auth Check",
        category=PluginCategory.EXPLOITATION,
        description="WinRM (5985/5986) authentication test with found credentials",
        depends_on=["port_scan"],
        produces=["winrm_access"],
        timeout=30.0,
        requires_http=False,
        requires_credentials=True,
        platform="windows",
        risk_level="noisy",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []
        data: dict = {"accessible": False}

        # Check if WinRM ports are open
        winrm_port = None
        if ctx.net:
            for port in (5985, 5986):
                if await ctx.net.port_open(target.host, port, timeout=3.0):
                    winrm_port = port
                    break

        if not winrm_port:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("WinRM ports not open", tags=["winrm"])],
            )

        findings.append(Finding.info(
            f"WinRM service on port {winrm_port}",
            evidence=f"{target.host}:{winrm_port}",
            tags=["winrm"],
        ))

        # Try auth with discovered credentials via HTTP
        if ctx.http:
            creds = ctx.state.get("credentials", [])
            for cred in creds:
                if ctx.should_stop:
                    break
                scheme = "https" if winrm_port == 5986 else "http"
                url = f"{scheme}://{target.host}:{winrm_port}/wsman"
                try:
                    async with ctx.rate:
                        resp = await ctx.http.post(
                            url,
                            headers={"Content-Type": "application/soap+xml"},
                            data="<s:Envelope/>",
                            timeout=5.0,
                        )
                        if resp.status == 401:
                            findings.append(Finding.info(
                                f"WinRM auth required (HTTP {resp.status})",
                                tags=["winrm"],
                            ))
                        elif resp.status == 200:
                            data["accessible"] = True
                            findings.append(Finding.critical(
                                f"WinRM access with {cred.get('username', '')}",
                                evidence=f"Auth OK: {cred['username']}@{url}",
                                description="Remote command execution possible",
                                remediation="Restrict WinRM access via firewall",
                                tags=["winrm", "rce"],
                            ))
                            break
                except Exception:
                    logger.debug("WinRM check failed for %s", url)

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )
