"""NFS enumeration â€” showmount, mount shares, file listing."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

NFS_PORTS = [111, 2049]


class NfsEnumPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="nfs_enum",
        display_name="NFS Enumeration",
        category=PluginCategory.EXPLOITATION,
        description="NFS share enumeration, showmount, access check",
        depends_on=["port_scan"],
        produces=["nfs_shares"],
        timeout=30.0,
        requires_http=False,
        risk_level="safe",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []
        data: dict = {"shares": []}

        # Check if NFS ports are open
        nfs_open = False
        if ctx.net:
            for p in NFS_PORTS:
                if await ctx.net.port_open(target.host, p, timeout=3.0):
                    nfs_open = True
                    break

        if not nfs_open:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("NFS ports not open", tags=["nfs"])],
            )

        # Use showmount via subprocess if available
        if ctx.subprocess_mgr and ctx.subprocess_mgr.is_available("showmount"):
            result = await ctx.subprocess_mgr.run(
                ["showmount", "-e", target.host], timeout=10.0,
            )
            if result.ok and result.stdout:
                shares = self._parse_showmount(result.stdout)
                data["shares"] = shares
                if shares:
                    everyone_shares = [
                        s for s in shares if s.get("access") == "*"
                    ]
                    if everyone_shares:
                        findings.append(Finding.high(
                            f"NFS shares exported to everyone: "
                            f"{len(everyone_shares)}",
                            evidence="\n".join(
                                f"  {s['path']} -> {s['access']}"
                                for s in everyone_shares
                            ),
                            remediation="Restrict NFS exports to specific IPs",
                            tags=["nfs", "world-readable"],
                        ))
                    findings.append(Finding.medium(
                        f"NFS exports found: {len(shares)}",
                        evidence="\n".join(
                            f"  {s['path']} -> {s['access']}"
                            for s in shares
                        ),
                        tags=["nfs", "shares"],
                    ))
        else:
            findings.append(Finding.info(
                "NFS service detected (port 2049/111 open)",
                evidence=f"Host: {target.host}",
                description="Install nfs-common and use: showmount -e {host}",
                tags=["nfs"],
            ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )

    @staticmethod
    def _parse_showmount(output: str) -> list[dict]:
        """Parse showmount -e output."""
        shares = []
        for line in output.strip().splitlines()[1:]:  # Skip header
            parts = line.strip().split()
            if len(parts) >= 2:
                shares.append({
                    "path": parts[0],
                    "access": parts[1] if len(parts) > 1 else "*",
                })
        return shares
