"""RPC enumeration â€” endpoint mapper, MS-RPC interfaces."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

RPC_PORTS = [135, 111, 593]

# Well-known MS-RPC interfaces
KNOWN_INTERFACES = {
    "SAMR": "Accounts enumeration (SAM Remote)",
    "LSARPC": "LSA Remote Protocol",
    "DRSUAPI": "Directory Replication Service (DCSync target)",
    "NETLOGON": "Netlogon service",
    "SVCCTL": "Service Control Manager (remote service mgmt)",
    "ATSVC": "Task Scheduler (remote task creation)",
    "EPMAPPER": "Endpoint Mapper",
    "WKSSVC": "Workstation Service",
    "SRVSVC": "Server Service (share enumeration)",
    "IRemoteWinspool": "Print Spooler (PrintNightmare target)",
}


class RpcEnumPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="rpc_enum",
        display_name="RPC Enumeration",
        category=PluginCategory.EXPLOITATION,
        description="RPC endpoint mapper, MS-RPC interface enumeration",
        depends_on=["port_scan"],
        produces=["rpc_interfaces"],
        timeout=30.0,
        requires_http=False,
        risk_level="safe",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        findings: list[Finding] = []
        data: dict = {"interfaces": []}

        rpc_port = None
        if ctx.net:
            for p in RPC_PORTS:
                if await ctx.net.port_open(target.host, p, timeout=3.0):
                    rpc_port = p
                    break

        if not rpc_port:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("RPC ports not open", tags=["rpc"])],
            )

        # Use rpcdump.py from impacket if available
        if ctx.subprocess_mgr:
            result = await ctx.subprocess_mgr.run_impacket_tool(
                "rpcdump.py", [f"@{target.host}"], timeout=15.0,
            )
            if result.ok and result.stdout:
                interfaces = self._parse_rpcdump(result.stdout)
                data["interfaces"] = interfaces

                interesting = [
                    i for i in interfaces
                    if any(k.lower() in i.get("name", "").lower()
                           for k in KNOWN_INTERFACES)
                ]
                if interesting:
                    findings.append(Finding.medium(
                        f"MS-RPC interfaces found: {len(interfaces)} "
                        f"({len(interesting)} interesting)",
                        evidence="\n".join(
                            f"  {i['name']}: {i.get('binding', '')}"
                            for i in interesting[:15]
                        ),
                        tags=["rpc", "interfaces"],
                    ))
                else:
                    findings.append(Finding.info(
                        f"RPC endpoint mapper: {len(interfaces)} interfaces",
                        tags=["rpc"],
                    ))
            else:
                findings.append(Finding.info(
                    f"RPC port {rpc_port} open",
                    evidence=f"Port {rpc_port} on {target.host}",
                    tags=["rpc"],
                ))
        else:
            findings.append(Finding.info(
                f"RPC port {rpc_port} open (impacket not available for enum)",
                tags=["rpc"],
            ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )

    @staticmethod
    def _parse_rpcdump(output: str) -> list[dict]:
        """Parse rpcdump.py output."""
        interfaces = []
        current: dict = {}
        for line in output.splitlines():
            line = line.strip()
            if line.startswith("Protocol:"):
                if current:
                    interfaces.append(current)
                current = {"protocol": line.split(":", 1)[1].strip()}
            elif line.startswith("Provider:"):
                current["name"] = line.split(":", 1)[1].strip()
            elif line.startswith("UUID"):
                current["uuid"] = line.split(":", 1)[1].strip() if ":" in line else ""
            elif line.startswith("Bindings:"):
                current["binding"] = line.split(":", 1)[1].strip()
        if current:
            interfaces.append(current)
        return interfaces
