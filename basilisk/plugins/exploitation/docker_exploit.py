"""Docker exploitation — exposed Docker API RCE, container escape vectors."""

from __future__ import annotations

import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target

logger = logging.getLogger(__name__)

DOCKER_PORTS = [2375, 2376]


class DockerExploitPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="docker_exploit",
        display_name="Docker API Exploitation",
        category=PluginCategory.EXPLOITATION,
        description="Exposed Docker API RCE, container enumeration",
        depends_on=["port_scan"],
        produces=["docker_access"],
        timeout=30.0,
        requires_http=True,
        risk_level="destructive",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available",
            )

        findings: list[Finding] = []
        data: dict = {"accessible": False, "containers": []}

        for port in DOCKER_PORTS:
            if ctx.should_stop:
                break
            scheme = "https" if port == 2376 else "http"
            base = f"{scheme}://{target.host}:{port}"

            try:
                async with ctx.rate:
                    resp = await ctx.http.get(base + "/version", timeout=5.0)
                    if resp.status == 200:
                        body = await resp.text(encoding="utf-8", errors="replace")
                        if "ApiVersion" in body or "Version" in body:
                            data["accessible"] = True
                            data["api_url"] = base
                            findings.append(Finding.critical(
                                f"Docker API exposed on port {port}",
                                evidence=f"URL: {base}/version\nResponse: {body[:300]}",
                                description=(
                                    "Unauthenticated Docker API = full host RCE. "
                                    "Create a privileged container to escape to host."
                                ),
                                remediation=(
                                    "Enable TLS authentication for Docker API, "
                                    "bind to 127.0.0.1, use firewall rules"
                                ),
                                tags=["docker", "api", "rce"],
                            ))

                            # Enumerate containers
                            await self._enum_containers(
                                ctx, base, findings, data,
                            )
                            break
            except Exception:
                continue

        if not findings:
            findings.append(Finding.info(
                "Docker API not exposed", tags=["docker"],
            ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )

    async def _enum_containers(self, ctx, base, findings, data):
        """Enumerate running containers."""
        try:
            async with ctx.rate:
                resp = await ctx.http.get(
                    base + "/containers/json?all=true", timeout=5.0,
                )
                if resp.status == 200:
                    body = await resp.text(encoding="utf-8", errors="replace")
                    # Basic parsing — body is JSON array
                    if body.startswith("["):
                        import json
                        containers = json.loads(body)
                        data["containers"] = [
                            {
                                "id": c.get("Id", "")[:12],
                                "image": c.get("Image", ""),
                                "state": c.get("State", ""),
                                "names": c.get("Names", []),
                            }
                            for c in containers[:20]
                        ]
                        if containers:
                            findings.append(Finding.high(
                                f"Docker containers enumerated: {len(containers)}",
                                evidence="\n".join(
                                    f"  {c.get('Id', '')[:12]}: "
                                    f"{c.get('Image', '')} ({c.get('State', '')})"
                                    for c in containers[:10]
                                ),
                                tags=["docker", "containers"],
                            ))
        except Exception:
            logger.debug("Docker container enum failed")

        # Check for images
        try:
            async with ctx.rate:
                resp = await ctx.http.get(
                    base + "/images/json", timeout=5.0,
                )
                if resp.status == 200:
                    body = await resp.text(encoding="utf-8", errors="replace")
                    if body.startswith("["):
                        import json
                        images = json.loads(body)
                        data["images"] = len(images)
        except Exception:
            pass
