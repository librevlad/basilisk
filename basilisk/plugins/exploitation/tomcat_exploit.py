"""Tomcat exploitation â€” Manager WAR deploy, Ghostcat, text API."""

from __future__ import annotations

import base64
import logging
from typing import ClassVar

from basilisk.core.plugin import BasePlugin, PluginCategory, PluginMeta
from basilisk.models.result import Finding, PluginResult
from basilisk.models.target import Target
from basilisk.utils.http import resolve_base_urls

logger = logging.getLogger(__name__)

# Default Tomcat credentials
TOMCAT_CREDS = [
    ("tomcat", "tomcat"), ("admin", "admin"), ("manager", "manager"),
    ("tomcat", "s3cret"), ("admin", "password"), ("tomcat", "password"),
    ("admin", "tomcat"), ("role1", "tomcat"), ("both", "tomcat"),
    ("admin", ""), ("tomcat", ""), ("admin", "admin123"),
    ("tomcat", "changethis"), ("admin", "j5Brn9"),
]

# Manager paths to check
MANAGER_PATHS = [
    "/manager/html", "/manager/text", "/manager/status",
    "/host-manager/html", "/manager/jmxproxy",
]


class TomcatExploitPlugin(BasePlugin):
    meta: ClassVar[PluginMeta] = PluginMeta(
        name="tomcat_exploit",
        display_name="Tomcat Exploitation",
        category=PluginCategory.EXPLOITATION,
        description="Tomcat Manager brute, WAR deploy, Ghostcat AJP",
        depends_on=["tech_detect"],
        produces=["tomcat_access"],
        timeout=60.0,
        risk_level="noisy",
    )

    async def run(self, target: Target, ctx) -> PluginResult:
        if ctx.http is None:
            return PluginResult.fail(
                self.meta.name, target.host, error="HTTP client not available",
            )

        findings: list[Finding] = []
        data: dict = {"manager_access": False, "credentials": []}

        # Check if Tomcat is detected
        tech_result = ctx.pipeline.get(f"tech_detect:{target.host}")
        is_tomcat = False
        if tech_result and tech_result.ok:
            techs = tech_result.data.get("technologies", [])
            is_tomcat = any(
                "tomcat" in t.get("name", "").lower() for t in techs
            )

        if not is_tomcat:
            # Quick check for Tomcat
            base_urls = await resolve_base_urls(target, ctx)
            if not base_urls:
                return PluginResult.success(
                    self.meta.name, target.host,
                    findings=[Finding.info("Host not reachable", tags=["tomcat"])],
                )
            for base_url in base_urls:
                try:
                    async with ctx.rate:
                        r = await ctx.http.get(base_url + "/", timeout=5.0)
                        body = await r.text(encoding="utf-8", errors="replace")
                        if "tomcat" in body.lower() or "catalina" in body.lower():
                            is_tomcat = True
                            break
                except Exception:
                    continue

        if not is_tomcat:
            return PluginResult.success(
                self.meta.name, target.host,
                findings=[Finding.info("Tomcat not detected", tags=["tomcat"])],
            )

        base_urls = await resolve_base_urls(target, ctx)
        if not base_urls:
            return PluginResult.fail(
                self.meta.name, target.host, error="Host not reachable",
            )

        # Try manager access with default credentials
        for base_url in base_urls:
            if ctx.should_stop:
                break
            for path in MANAGER_PATHS:
                if ctx.should_stop:
                    break
                for username, password in TOMCAT_CREDS:
                    if ctx.should_stop:
                        break
                    auth = base64.b64encode(
                        f"{username}:{password}".encode(),
                    ).decode()
                    try:
                        async with ctx.rate:
                            resp = await ctx.http.get(
                                base_url + path,
                                headers={"Authorization": f"Basic {auth}"},
                                timeout=5.0,
                            )
                            if resp.status == 200:
                                data["manager_access"] = True
                                data["credentials"].append({
                                    "username": username,
                                    "password": password,
                                    "path": path,
                                })
                                findings.append(Finding.critical(
                                    f"Tomcat Manager access: {username}:{password}",
                                    evidence=(
                                        f"URL: {base_url}{path}\n"
                                        f"Credentials: {username}:{password}\n"
                                        f"Status: 200"
                                    ),
                                    description=(
                                        "Tomcat Manager allows WAR deployment = RCE. "
                                        "Deploy a malicious WAR to get a reverse shell."
                                    ),
                                    remediation=(
                                        "Change default credentials, restrict Manager "
                                        "access to localhost"
                                    ),
                                    tags=["tomcat", "manager", "rce"],
                                ))
                                # One success is enough
                                return PluginResult.success(
                                    self.meta.name, target.host,
                                    findings=findings, data=data,
                                )
                            elif resp.status == 403:
                                findings.append(Finding.info(
                                    f"Tomcat Manager found but access denied: {path}",
                                    tags=["tomcat"],
                                ))
                                break  # Skip remaining creds for this path
                    except Exception:
                        continue

        # Check for Ghostcat (AJP on port 8009)
        if ctx.net and await ctx.net.port_open(target.host, 8009, timeout=3.0):
            findings.append(Finding.high(
                "AJP port 8009 open (potential Ghostcat CVE-2020-1938)",
                evidence=f"AJP port open on {target.host}:8009",
                description="AJP connector allows file read and potential RCE",
                remediation="Disable AJP connector or restrict to localhost",
                tags=["tomcat", "ghostcat", "ajp"],
            ))

        if not findings:
            findings.append(Finding.info(
                "Tomcat detected but no default credentials or Ghostcat",
                tags=["tomcat"],
            ))

        return PluginResult.success(
            self.meta.name, target.host, findings=findings, data=data,
        )
