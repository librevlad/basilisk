"""XSS scenario â€” native v4 implementation."""

from __future__ import annotations

import re
from typing import Any, ClassVar

from basilisk.domain.finding import Finding, Proof
from basilisk.domain.scenario import Scenario, ScenarioMeta, ScenarioResult
from basilisk.domain.surface import SearchSurface, Surface
from basilisk.domain.target import BaseTarget
from basilisk.models.result import Severity

_XSS_CANARY = "basiliskXSS42"

_XSS_PAYLOADS = [
    "<script>alert(1)</script>",
    '"><img src=x onerror=alert(1)>',
    "'-alert(1)-'",
    "<svg/onload=alert(1)>",
    "javascript:alert(1)",
    "<img src=x onerror=alert(1)>",
]


class XssScenario(Scenario):
    """Detects reflected XSS with context-aware analysis."""

    meta: ClassVar[ScenarioMeta] = ScenarioMeta(
        name="xss_scenario",
        display_name="XSS Scanner (v4)",
        category="pentesting",
        description="Detects reflected XSS with context-aware analysis and payload injection",
        target_surfaces=["search", "generic"],
        produces=["xss_findings"],
        timeout=90.0,
        risk_level="noisy",
        requires_knowledge=["Host", "Service:http", "Endpoint:params"],
        produces_knowledge=["Finding"],
        cost_score=4.0,
        noise_score=5.0,
    )

    async def run(
        self,
        target: BaseTarget,
        actor: Any,
        surfaces: list[Surface],
        tools: dict[str, Any],
    ) -> ScenarioResult:
        findings: list[Finding] = []
        data: dict[str, Any] = {"xss_tests": []}
        tested: set[str] = set()

        base_url = target.base_url
        test_surfaces = surfaces or self._default_surfaces(target)

        for surface in test_surfaces:
            if actor.should_stop:
                break

            for param_name in surface.params:
                key = f"{surface.url}:{param_name}"
                if key in tested:
                    continue
                tested.add(key)

                # Phase 1: Reflection probe
                url = surface.url or base_url
                try:
                    canary_params = dict(surface.params)
                    canary_params[param_name] = _XSS_CANARY
                    qs = "&".join(f"{k}={v}" for k, v in canary_params.items())
                    resp = await actor.http_get(f"{url}?{qs}", timeout=10)
                except Exception:
                    continue

                if _XSS_CANARY not in resp.text:
                    data["xss_tests"].append({
                        "param": param_name, "reflected": False,
                    })
                    continue

                # Phase 2: Context detection
                context = _detect_context(resp.text, _XSS_CANARY)

                # Phase 3: Payload injection
                for payload in _XSS_PAYLOADS:
                    if actor.should_stop:
                        break

                    try:
                        inject_params = dict(surface.params)
                        inject_params[param_name] = payload
                        qs = "&".join(f"{k}={v}" for k, v in inject_params.items())
                        resp2 = await actor.http_get(f"{url}?{qs}", timeout=10)
                    except Exception:
                        continue

                    body = resp2.text
                    data["xss_tests"].append({
                        "param": param_name, "payload": payload,
                        "reflected": True, "context": context,
                    })

                    # Check for unfiltered payload reflection
                    if payload in body:
                        severity = Severity.HIGH
                        conf = 0.85
                        if "<script>" in payload and "<script>" in body:
                            severity = Severity.CRITICAL
                            conf = 0.9
                        elif "onerror=" in payload and "onerror=" in body:
                            severity = Severity.HIGH
                            conf = 0.85

                        findings.append(Finding(
                            title=f"XSS in {param_name} ({context} context)",
                            severity=severity,
                            proof=Proof(
                                description="Reflected XSS: payload rendered "
                                f"unfiltered in {context}",
                                payload_used=payload,
                                raw_request=f"GET {url}?{param_name}={payload}",
                                raw_response=body[:500],
                            ),
                            host=target.host,
                            endpoint=url,
                            scenario_name=self.meta.name,
                            confidence=conf,
                            tags=frozenset({"xss", "reflected", context}),
                        ))
                        break  # Found XSS for this param

        return ScenarioResult(
            scenario=self.meta.name,
            target=target.host,
            findings=findings,
            data=data,
            status="success",
        )

    @staticmethod
    def _default_surfaces(target: BaseTarget) -> list[Surface]:
        base = target.base_url
        return [
            SearchSurface(
                host=target.host, url=f"{base}/search",
                params={"q": "test"}, query_param="q",
            ),
        ]


def _detect_context(html: str, canary: str) -> str:
    """Detect the HTML context where the canary appears."""
    idx = html.find(canary)
    if idx < 0:
        return "unknown"
    before = html[max(0, idx - 100):idx]
    if re.search(r"<script[^>]*>", before, re.I):
        return "script"
    if re.search(r'=\s*["\']?\s*$', before):
        return "attribute"
    if re.search(r"<[a-z]+[^>]*$", before, re.I):
        return "tag"
    return "html"
